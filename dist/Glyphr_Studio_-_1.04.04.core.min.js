function glyphrStudio_OnLoad(){if(console.log("%c\n       GG              GG\n       G               G\n GGGG  G GG   G  GGGG  GGGGG   GGGGG\nG    G G G    G G    G G    G G     G\nG    G G G    G G    G G    G G\n GGGGG G  GGGGG GGGGG  GG   G GG\nGG   G   GG   G G             STUDIO\n GGGG     GGGG  GG\n\nv"+_UI.thisGlyphrStudioVersionNum+"\n\n","color:rgb(0,170,225)"),insertGlobalDOMElements(),setupGhostCanvas(),_UI.devmode&&_UI.devnav){if(_UI.loadsampleproject){var a=_UI.sampleproject[_UI.loadsampleproject];hydrateGlyphrProject(a),_UI.loadsampleproject=!1}else newGlyphrProject();_UI.navhere=_UI.devnav}var b=_UI.devmode?_UI.devnavprimary:!1;navigate(b),_UI.devmode&&_UI.testOnLoad(),document.title="Glyphr Studio"}function insertGlobalDOMElements(){var a='<div id="dialog_box"><table cellpadding=0 cellspacing=0 border=0><tr><td id="dialogLeftBar"><button class="dialogCloseButton" onclick="closeDialog();">&times;</button></td><td id="dialogRightContent"></td></tr></table></div>',b='<table id="big_dialog_box" cellpadding=0 cellspacing=0 border=0><tr><td id="dialogLeftBar"><button class="dialogCloseButton" onclick="closeDialog();">&times;</button></td><td id="bigDialogLeftContent"></td><td style="height:9999px;"><div id="bigDialogScrollContent"></div></td></tr></table>',c='<span id="toast"></span>',d='<div id="npSave"></div>';d+='<div id="saveFormatFlyout" style="display:none;">',d+='<div class="closeFormatFlyout" onclick="closeDialog();">&times</div>',d+='<button onclick="saveGlyphrProjectFile(); closeDialog();">'+makeIcon({name:"button_npNav",width:32,height:32,size:50,color:_UI.colors.blue.l95,hovercolor:!1})+"<span>Glyphr Studio Project File</span></button>",d+="<button onclick=\"closeDialog(); showToast('Exporting OTF font file...'); setTimeout(ioOTF_exportOTFfont, 500);\">"+makeIcon({name:"nav_exportotf",width:32,height:32,size:50,color:_UI.colors.blue.l95,hovercolor:!1})+"<span>OTF Font</span></button>",d+="<button onclick=\"closeDialog(); showToast('Exporting SVG font file...'); setTimeout(ioSVG_exportSVGfont, 500);\">"+makeIcon({name:"nav_exportsvg",width:32,height:32,size:50,color:_UI.colors.blue.l95,hovercolor:!1})+"<span>SVG Font</span></button>",d+="</div>",document.body.innerHTML='<div id="primaryScreenLayout"></div>',document.body.innerHTML+='<canvas id="ishereghostcanvas" height=10 width=10 ></canvas>',document.body.innerHTML+=d,document.body.innerHTML+=c,document.body.innerHTML+='<div id="dialog_bg" onclick="closeDialog();"></div>',document.body.innerHTML+=a,document.body.innerHTML+=b,window.onbeforeunload=ohNoes}function ohNoes(){return popIn(),_GP&&_GP.projectsettings.stoppagenavigation&&_UI.stoppagenavigation&&!_UI.devmode?"\n\nOh Noes!\nUnless you specifically saved your Glyphr Project, all your progress will be lost.\n\n":void 0}function makePanelSuperTitle(){var a="";if(!_UI.popout){var b,c=getSelectedWorkItem();if(a+='<h1 class="panelsupertitle">'+_UI.navhere.toUpperCase(),"npChooser"===_UI.navprimaryhere||"npGuides"===_UI.navprimaryhere||"npHistory"===_UI.navprimaryhere)return a+"</h1>";c?(b=c.getName()||c.glyphhtml||c.shape.name||"[no shape outline yet]",c.name&&(b=b.replace(/latin /i,"")),a+=makeSuperTitleSeperator(),a+=b):"kerning"===_UI.navhere&&(b=getSelectedKern(),a+=b?makeSuperTitleSeperator()+b.getName():""),a+="</h1>"}return a}function makeSuperTitleSeperator(){var a='<span class="supertitleseperator">';return a+=makeIcon({name:"button_more",color:_UI.colors.blue.l75,hovercolor:_UI.colors.blue.l75,size:10}),a+=makeIcon({name:"button_more",color:_UI.colors.blue.l75,hovercolor:_UI.colors.blue.l75,size:10}),a+="</span>"}function debug(a,b){_UI.devmode&&(_UI.debug||b)&&("string"==typeof a?(a=a.replace(/&lt;/gi,"<"),a=a.replace(/&gt;/gi,">"),console.log(a)):"object"==typeof a&&console.table(a))}function json(a,b){if(a=clone(a),b)return JSON.stringify(a);var c=JSON.stringify(a,void 0,"	");return c?c.replace(/\n/g,"\r\n"):""}function closeDialog(){document.getElementById("dialog_bg").style.display="none",document.getElementById("dialog_box").style.display="none",document.getElementById("dialogRightContent").innerHTML="<b>Error: unspecified dialog box content.</b>",document.getElementById("big_dialog_box").style.display="none",document.getElementById("bigDialogLeftContent").innerHTML="<b>Error: unspecified dialog box content.</b>",document.getElementById("saveFormatFlyout").style.display="none",!_UI.popout&&document.getElementById("npSave")&&(document.getElementById("npSave").style.backgroundColor="transparent")}function openDialog(a){closeDialog(),document.body.focus();var b=document.getElementById("dialogRightContent");b.innerHTML=a,b.style.height>800?b.style.height=800:b.style.width="auto",document.getElementById("dialog_box").style.display="block",document.getElementById("dialog_bg").style.display="block"}function openBigDialog(a){closeDialog(),document.body.focus(),document.getElementById("bigDialogLeftContent").innerHTML=a,document.getElementById("bigDialogScrollContent").innerHTML=make_GlyphChooser(_UI.glyphchooser.dialog),document.getElementById("big_dialog_box").style.display="block",document.getElementById("dialog_bg").style.display="block"}function isBigDialogOpen(){return"block"===document.getElementById("big_dialog_box").style.display}function openNotation(a,b,c){getEditDocument().body.focus();var d=getEditDocument().getElementById("notation");d.innerHTML=a,d.style.top=round(c)+"px",d.style.left=round(b+50)+"px",d.style.display="block"}function closeNotation(){getEditDocument().getElementById("notation").style.display="none",getEditDocument().getElementById("notation").innerHTML="&#x20E2;",getEditDocument().body.focus()}function toggleDialog_ExportOptions(){var a=document.getElementById("saveFormatFlyout"),b=document.getElementById("npSave");"block"===a.style.display?closeDialog():(b.style.backgroundColor=_UI.colors.blue.l45,a.style.display="block")}function makeErrorMessageBox(){var a='<div id="errormessagebox" style="display:none;"><table cellpadding=0 cellspacing=0 border=0><tr><td class="errormessageleftbar"><button class="errormessageclosebutton" onclick="closeErrorMessageBox();">&times;</button></td><td id="errormessagecontent"></td></tr></table></div>';return a}function showErrorMessageBox(a){var b=document.getElementById("errormessagecontent"),c=document.getElementById("errormessagebox");b.innerHTML=a,c.style.display="block",console.warn(a)}function closeErrorMessageBox(){document.getElementById("errormessagecontent").innerHTML="",document.getElementById("errormessagebox").style.display="none"}function showToast(a,b){function c(){k=l,m=n,i.style.marginTop=l+"px",i.style.opacity=n,_UI.timeout=setTimeout(e,j)}function d(){_UI.timeout&&clearTimeout(_UI.timeout),0>f?(i.style.display="block",i.style.marginTop="-50px;",i.style.opacity="0.0",i.style.borderBottomWidth="0px",f++,_UI.timeout=setTimeout(d,g)):20>=f?(f++,k+=(l-k)/h,m+=(n-m)/h,i.style.marginTop=k+"px",i.style.opacity=m,_UI.timeout=setTimeout(d,g)):c()}function e(){0>f?(i.style.display="none",i.style.marginTop="-50px;",i.style.opacity="0.0",i.innerHTML="0_o"):(f--,k-=k/h,m-=m/h,i.style.marginTop=k+"px",i.style.opacity=m,_UI.timeout=setTimeout(e,g))}debug("\n showToast - START");var f=-1,g=10,h=5,i=getEditDocument().getElementById("toast"),j=b||3e3;i.innerHTML=a||"Howdy!";var k=-50,l=15,m=0,n=1;_UI.timeout=setTimeout(d,1),debug(" showToast - END\n")}function setProjectAsSaved(){_UI.projectsaved=!0,_UI.popout?(document.title="Glyphr Studio - Tools",_UI.popout.document.title="Glyphr Studio - Canvas"):document.title="Glyphr Studio",updateSaveIcon()}function setProjectAsUnsaved(){_UI.projectsaved=!1,_UI.popout?(document.title=" ❖ Glyphr Studio - Tools",_UI.popout.document.title=" ❖ Glyphr Studio - Canvas"):document.title=" ❖ Glyphr Studio",updateSaveIcon()}function updateSaveIcon(){if("npNav"!==_UI.navprimaryhere){var a=_UI.colors.gray.l90;_UI.projectsaved||(a="white"),document.getElementById("npSave").innerHTML='<table class="saveButtonTable"><tr><td style="border-right:1px solid rgb(204, 209, 214);"><button class="primarynavbutton" style="height:32px; width:38px; padding:4px 0px 0px 7px;" title="Save Glyphr Project File" onclick="saveGlyphrProjectFile();">'+makeIcon({name:"button_npSave",size:24,color:a,hovercolor:"white"})+'</button></td><td><button class="primarynavbutton" style="height:36px; width:21px; text-align:left; padding:0px 0px 0px 4px;" title="Save File Format Options" onclick="toggleDialog_ExportOptions();">'+makeIcon({name:"button_more",height:10,width:10,size:10,color:a,hovercolor:"white"})+"</button></td></tr></table>"}}function saveFile(a,b,c){c=c||"text/plain;charset=utf-8";var d=new Blob([b],{type:c,endings:"native"});try{return void window.navigator.msSaveBlob(d,a)}catch(e){var f=document.createElement("a");window.URL=window.URL||window.webkitURL,f.href=window.URL.createObjectURL(d),f.download=a;var g=document.createEvent("MouseEvents");return g.initEvent("click",!0,!1),void f.dispatchEvent(g)}console.error("File could not be saved: "+a)}function clone(a){var b=a instanceof Array?[]:{};for(var c in a)b[c]=a[c]&&"object"==typeof a[c]&&"parentpath"!==c?clone(a[c]):a[c];return b}function round(a,b){return a?(b=b||0,Number(Math.round(a+"e"+b)+"e-"+b)||0):0}function numSan(a){a=parseFloat(a);var b=""+a;return(b.indexOf("0000")>-1||b.indexOf("9999")>-1)&&(a=round(a,6)),0>a&&a>0&&(a=0),a}function strSan(a){return a.replace(/[<>'"\\]/g,"")}function trim(a){try{return a=a.replace(/^\s+|\s+$/g,""),a.replace(/(\r\n|\n|\r|\t)/gm,"")}catch(b){return""}}function isval(a){return 0===a?!0:a===!1?!0:"object"==typeof a&&0===Object.keys(a).length?!1:!!a}function getOverallMaxes(a){for(var b=clone(_UI.mins),c=0;c<a.length;c++)a[c]=a[c]||clone(_UI.mins),b.xmax=Math.max(b.xmax,a[c].xmax),b.xmin=Math.min(b.xmin,a[c].xmin),b.ymax=Math.max(b.ymax,a[c].ymax),b.ymin=Math.min(b.ymin,a[c].ymin);return b}function calculateAngle(a,b){return b=b||{x:0,y:0},result=Math.atan2(a.y-b.y,a.x-b.x),isNaN(result)&&(console.warn("calculateAngle returned NaN\n"+json(a)+"\n"+json(b)),result=0),result}function calculateLength(a,b){var c=b.x-a.x,d=b.y-a.y,e=Math.sqrt(c*c+d*d);return e}function rotate(a,b,c){if(b&&a){c=c||{x:0,y:0},a.x-=c.x,a.y-=c.y;var d=a.x*Math.cos(b)-a.y*Math.sin(b),e=a.x*Math.sin(b)+a.y*Math.cos(b);a.x=d+c.x,a.y=e+c.y}}function rad(a){return a*Math.PI/180%Math.PI}function deg(a){return 180*a/Math.PI%360}function calculateNiceAngle(a){return a=deg(a),a=360-a,a-=270,a%=360,0>a&&(a+=360),a}function niceAngleToAngle(a){return a+=90,a%=360,180>a?a=360-a:a*=-1,a=rad(a)}function getFirstID(a){for(var b in a)if(a.hasOwnProperty(b))return b;return!1}function generateNewID(a,b){var c=1;b=b||"id";for(var d=""+b+c;a.hasOwnProperty(d);)d=""+b+ ++c;return d}function getMyID(a){for(var b in _GP.glyphs)if(_GP.glyphs.hasOwnProperty(b)&&a===_GP.glyphs[b])return b;for(var c in _GP.components)if(_GP.components.hasOwnProperty(c)&&a===_GP.components[c])return c;for(var d in _GP.ligatures)if(_GP.ligatures.hasOwnProperty(d)&&a===_GP.ligatures[d])return d;return!1}function getLength(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b}function genEmailContent(){var a="Have a feature idea or ran into an issue%3F We%27d be happy to help!";return a+="%0A%0A%0A%0A___________________________________________%0A",a+="version %09Glyphr Studio "+_UI.thisGlyphrStudioVersionNum+"%0A",a+="app name %09"+navigator.appName+"%0A",a+="language %09"+navigator.language+"%0A",a+="platform %09"+navigator.platform+"%0A",a+="user agent %09"+encodeURIComponent(navigator.userAgent)+"%0A"}function shiftColor(a,b,c){b=Math.max(0,Math.min(b,1));var d={};return"#"===a.charAt(0)?(a=a.substring(1,7),d.r=parseInt(a.substring(0,2),16),d.g=parseInt(a.substring(2,4),16),d.b=parseInt(a.substring(4,6),16)):"rgb("===a.substring(0,4)?(a=a.split("(")[1].split(")")[0].split(","),d.r=a[0],d.g=a[1],d.b=a[2]):(d.r=0,d.g=0,d.b=0),d.r=Math.max(0,Math.min(d.r,255)),d.g=Math.max(0,Math.min(d.g,255)),d.b=Math.max(0,Math.min(d.b,255)),c?(d.r=round((255-1*d.r)*b+1*d.r),d.g=round((255-1*d.g)*b+1*d.g),d.b=round((255-1*d.b)*b+1*d.b)):(d.r=round(1*d.r-d.r*b),d.g=round(1*d.g-d.g*b),d.b=round(1*d.b-d.b*b)),"rgb("+d.r+","+d.g+","+d.b+")"}function importGlyphrProjectFromText(a){function b(a){return a=a.split("."),{major:1*a[0],minor:1*a[1],patch:1*a[2]}}var c;try{c=JSON.parse(a)}catch(d){c={}}var e=!1,f=!1,g=c.projectsettings;if(g&&(e=g.versionnum,f=g.version),!f)return void error_NoVersionFound();e||(e="0.3.0",g.initialversionnum="0.3.0"),g.initialversionnum||(g.initialversionnum=e);var h=b(e),i=b(_UI.thisGlyphrStudioVersionNum);return h.major>i.major?void error_TimeTraveller():(0===h.major&&(c=migrate_betas_to_v1(c,h.minor),h.major=1,h.minor=0),1===h.major&&h.minor>i.minor?void error_TimeTraveller():(g.versionnum=_UI.thisGlyphrStudioVersionNum,g.version=_UI.thisGlyphrStudioVersion,void hydrateGlyphrProject(c)))}function error_NoVersionFound(){var a="File does not appear to be a Glyphr Project.  No version information was found.  Please try a different file...";console.warn(a),alert(a)}function error_TimeTraveller(){var a="Your Glyphr Project was created with a later version of Glyphr Studio.  This version of Glyphr Studio cannot open project files created in the future O_o (whoa).  Please go to glyphrstudio.com to get the latest release.";console.warn(a),alert(a)}function migrate_betas_to_v1(a,b){switch(b){case 3:a=migrate_0_3_to_0_4(a),b=4;case 4:a=migrate_0_4_to_0_5(a),b=5;case 5:a=migrate_0_5_to_1_0(a)}return a}function migrate_0_5_to_1_0(a){a.glyphs=clone(a.fontchars),a.components=clone(a.linkedshapes),a.projectsettings.glyphrange=clone(a.projectsettings.charrange),delete a.fontchars,delete a.linkedshapes,delete a.projectsettings.charrange;var b,c,d,e;for(var f in a.components)a.components.hasOwnProperty(f)&&(b=a.components[f],b.shape?(c=[b.shape],e=b.shape.name||"Shape"):(c=[],e="Shape"),d=b.usedin?b.usedin:[],a.components[f]=new Glyph({shapes:c,usedin:d,name:e,glyphhtml:""}));for(var g in a.glyphs)a.glyphs.hasOwnProperty(g)&&(a.glyphs[g]=charToGlyph(a.glyphs[g]));for(var h in a.ligatures)a.ligatures.hasOwnProperty(h)&&(a.ligatures[h]=charToGlyph(a.ligatures[h]));return a}function charToGlyph(a){var b,c,d;a.shapes=a.charshapes||[],a.name=a.charname||!1,a.glyphhtml=a.charhtml||!1,a.glyphwidth=a.charwidth||!1,delete a.charshapes,delete a.charname,delete a.charhtml,delete a.charwidth,b=a.shapes;for(var e=0;e<b.length;e++)sh=b[e],"linkedshapeinstance"===sh.objtype&&(c=sh.uselinkedshapexy?0:sh.xpos,d=sh.uselinkedshapexy?0:sh.ypos,b[e]=new ComponentInstance({name:sh.name,link:sh.link,translatex:c,translatey:d,xlock:sh.xlock,ylock:sh.ylock})),isval(b[e].uselinkedshapexy)&&(b[e].usecomponentxy=b[e].uselinkedshapexy,delete b[e].uselinkedshapexy);return a}function migrate_0_4_to_0_5(a){var b;for(var c in a.fontchars)a.fontchars.hasOwnProperty(c)&&(b=a.fontchars[c],b.charwidth=b.advancewidth||a.projectsettings.upm||1e3);return a}function migrate_0_3_to_0_4(a){newgp=new GlyphrProject;var b;for(var c in a.linkedshapes)if(a.linkedshapes.hasOwnProperty(c)&&(b=a.linkedshapes[c],b.usedin))for(var d=0;d<b.usedin.length;d++)b.usedin[d]=decToHex(b.usedin[d]);var e=newgp.projectsettings;for(var f in a.projectsettings)e.hasOwnProperty(f)&&(e[f]=a.projectsettings[f]);a.projectsettings=e;for(var g,h,i=0;i<a.fontchars.length;i++)g=a.fontchars[i],g&&(h="0x00"+g.cmapcode.substr(2).toUpperCase(),a.fontchars[h]=g,a.fontchars[h].charhtml=hexToHTML(h));return a}function hydrateGlyphrProject(a,b){_GP=new GlyphrProject;var c=clone(a.projectsettings.guides);a.projectsettings&&(_GP.projectsettings=merge(_GP.projectsettings,a.projectsettings),_GP.projectsettings.glyphrange.custom=a.projectsettings.glyphrange.custom||[]),_GP.projectsettings.projectid=_GP.projectsettings.projectid||genProjectID();for(var d in c)c.hasOwnProperty(d)&&(_GP.projectsettings.guides[d]=new Guide(c[d]));a.metadata&&(_GP.metadata=merge(_GP.metadata,a.metadata,!0));for(var e in a.components)a.components.hasOwnProperty(e)&&(_GP.components[e]=new Glyph(a.components[e]));for(var f in a.glyphs)a.glyphs.hasOwnProperty(f)&&(_GP.glyphs[f]=new Glyph(a.glyphs[f]));for(var g in a.ligatures)a.ligatures.hasOwnProperty(g)&&(_GP.ligatures[g]=new Glyph(a.ligatures[g]));for(var h in a.kerning)a.kerning.hasOwnProperty(h)&&(_GP.kerning[h]=new HKern(a.kerning[h]));b&&b(),_UI.coremode||finalizeGlyphrProject()}function merge(a,b,c){for(var d in a)a.hasOwnProperty(d)&&("object"==typeof a[d]?b.hasOwnProperty(d)&&(a[d]=merge(a[d],b[d])):b.hasOwnProperty(d)&&(a[d]="string"==typeof b[d]&&c?removeEmptyStringInputs(b[d]):b[d]));return a}function newGlyphrProject(){var a;a=document.getElementById("newprojectname")&&document.getElementById("newprojectname").value?document.getElementById("newprojectname").value:"My Font",_GP=new GlyphrProject,_GP.projectsettings.name=a,_GP.metadata.font_family=a,_GP.projectsettings.version=_UI.thisGlyphrStudioVersion,_GP.projectsettings.versionnum=_UI.thisGlyphrStudioVersionNum,_GP.projectsettings.projectid=genProjectID(),getGlyph("0x0020",!0).isautowide=!1,getGlyph("0x0020",!0).glyphwidth=_GP.projectsettings.upm/2,getGlyph("0x0041",!0),finalizeGlyphrProject()}function finalizeGlyphrProject(){_UI.history["glyph edit"]=new History("glyphs"),_UI.history.components=new History("components"),_UI.history.ligatures=new History("ligatures"),_UI.history.kerning=new History("kerning"),_UI.guides.leftgroup_xmax=new Guide(_UI.guides.leftgroup_xmax),_UI.guides.rightgroup_xmin=new Guide(_UI.guides.rightgroup_xmin);var a=_GP.projectsettings;a.guides={ascent:new Guide({name:"ascent",type:"horizontal",location:a.ascent,editable:!1,color:a.colors.guide_med}),capheight:new Guide({name:"capheight",type:"horizontal",location:a.capheight,editable:!1,color:a.colors.guide_light}),xheight:new Guide({name:"xheight",type:"horizontal",location:a.xheight,editable:!1,color:a.colors.guide_light}),baseline:new Guide({name:"baseline",type:"horizontal",location:0,editable:!1,color:a.colors.guide_dark}),descent:new Guide({name:"descent",type:"horizontal",location:a.ascent-a.upm,editable:!1,color:a.colors.guide_med}),leftside:new Guide({name:"leftside",type:"vertical",location:-1*a.defaultlsb,editable:!1,color:a.colors.guide_dark}),rightside:new Guide({name:"rightside",type:"vertical",location:a.upm,editable:!1,color:a.colors.guide_dark}),zero:new Guide({name:"zero",type:"vertical",showname:!1,location:0,editable:!1,color:a.colors.guide_med}),min:new Guide({name:"min",type:"vertical",showname:!1,location:a.upm,editable:!1,color:a.colors.guide_light}),max:new Guide({name:"max",type:"vertical",showname:!1,location:a.upm,editable:!1,color:a.colors.guide_light})},_UI.selectedglyph=_UI.selectedglyph||getFirstGlyphID(),_UI.selectedligature=_UI.selectedligature||getFirstID(_GP.ligatures),_UI.selectedcomponent=_UI.selectedcomponent||getFirstID(_GP.components),_UI.selectedkern=_UI.selectedkern||getFirstID(_GP.kerning),calculateDefaultView(),resetThumbView(),_UI.navhere="glyph edit"}function ComponentInstance(a){this.objtype="componentinstance",this.link=a.link||getFirstID(_GP.components),this.name=a.name||"Component Instance",this.translatex=parseFloat(a.translatex)||0,this.translatey=parseFloat(a.translatey)||0,this.scalew=parseFloat(a.scalew)||0,this.scaleh=parseFloat(a.scaleh)||0,this.flipew=a.flipew||!1,this.flipns=a.flipns||!1,this.reversewinding=a.reversewinding||!1,this.rotation=a.rotation||0,this.rotatefirst=a.rotatefirst||!1,this.xlock=a.xlock||!1,this.ylock=a.ylock||!1,this.wlock=a.wlock||!1,this.hlock=a.hlock||!1,this.ratiolock=a.ratiolock||!1,this.visible=isval(a.visible)?a.visible:!0,this.transformedglyphcache=!1}function showDialog_AddComponent(){var a=getLength(_GP.components)?"components":"glyphs";_UI.glyphchooser.dialog={fname:"insertComponentInstance",choices:"all",selected:a};var b="<h1>Add Component</h1>";b+="Components are groups of shapes that can be re-used across many Glyphs.  Component Instances can be transformed while the Root Component remains unchanged.<br><br>",b+="You can define and link to stand-alone Components, but you can also use Glyphs and Ligatures as if they were Root Components.<br><br>",b+="Choose a Glyph to insert as a Component Instance in this Glyph.",openBigDialog(b)}function insertComponentInstance(a,b){var c=!b;b=b||getSelectedWorkItemID();var d=getGlyph(b,!0);if(d.canAddComponent(a)){var e="Instance of "+getGlyphName(a),f=new ComponentInstance({link:a,name:e});return d.shapes.push(f),d.calcGlyphMaxes(),c&&(_UI.ms.shapes.select(f),_UI.selectedtool="shaperesize"),addToUsedIn(a,b),closeDialog(),history_put("insert component from glyphedit"),redraw({calledby:"insertComponent"}),!0}return openDialog('<h1>Whoops</h1><div class="dialoglargetext">A circular link was found, components can\'t include links to themselves.<br>They can\'t handle the philosophical conundrum it poses.</div><br><br><button class="buttonsel" onclick="closeDialog();">Fine, I guess.</button>'),!1}function turnComponentIntoShapes(){var a=_UI.ms.shapes.getSingleton(),b=a.getTransformedGlyph().shapes;_UI.ms.shapes.deleteShapes();for(var c=0;c<b.length;c++)addShape(b[c]);redraw({calledby:"turnComponentIntoShapes"})}function addToUsedIn(a,b){var c=getGlyph(a).usedin;c.push(""+b),c.sort(function(a,b){return a-b})}function removeFromUsedIn(a,b){var c=getGlyph(a).usedin,d=c.indexOf(""+b);-1!==d&&c.splice(d,1)}function Glyph(a){a=a||{},this.objtype="glyph",this.name=a.name||getGlyphName(a.glyphhex)||!1,this.glyphhtml=a.glyphhtml||hexToHTML(a.glyphhex)||!1,this.isautowide=isval(a.isautowide)?a.isautowide:!0,this.glyphwidth=isval(a.glyphwidth)?a.glyphwidth:0,this.leftsidebearing=isval(a.leftsidebearing)?a.leftsidebearing:!1,this.rightsidebearing=isval(a.rightsidebearing)?a.rightsidebearing:!1,this.ratiolock=isval(a.ratiolock)?a.ratiolock:!1,this.maxes=a.maxes||clone(_UI.mins),this.shapes=a.shapes||[],this.usedin=a.usedin||[],this.svg=a.svg||!1;var b=0,c=0;if(a.shapes&&a.shapes.length)for(var d=0;d<a.shapes.length;d++)"componentinstance"===a.shapes[d].objtype?(this.shapes[d]=new ComponentInstance(a.shapes[d]),b++):(this.shapes[d]=new Shape(a.shapes[d]),c++);this.calcGlyphMaxes?this.calcGlyphMaxes():console.warn("Importing Glyph "+this.name+" no calcGlyphMaxes()")}function getGlyph(a,b){if(!a)return!1;if(_GP==={})return!1;a=""+a;var c;if(a.indexOf("0x",2)>-1){if(c=_GP.ligatures[a])return c;if(b)return _GP.ligatures[a]=new Glyph({glyphhex:a}),_GP.ligatures[a]}else{if(!(a.indexOf("0x")>-1))return _GP.components[a]||!1;if(c=_GP.glyphs[a])return c;if(b)return _GP.glyphs[a]=new Glyph({glyphhex:a}),_GP.glyphs[a]}return!1}function getGlyphName(a){if(a=""+a,!a)return!1;var b=getUnicodeName(a);if(b&&"[name not found]"!==b)return b;var c=getGlyph(a);return a.indexOf("0x",2)>-1?c.name||hexToHTML(a):c.name||"[name not found]"}function getFirstGlyphID(){return _GP.glyphs["0x0041"]?"0x0041":getFirstID(_GP.glyphs)}function getSelectedGlyphLeftSideBearing(){var a=getSelectedWorkItem();return a?"component"===a.objtype?0:a.isautowide?a.leftsidebearing||_GP.projectsettings.defaultlsb:0:0}function getSelectedGlyphRightSideBearing(){var a=getSelectedWorkItem();return a?"component"===a.objtype?0:a.isautowide?a.rightsidebearing||_GP.projectsettings.defaultrsb:0:0}function updateCurrentGlyphWidth(){var a=getSelectedWorkItem();if(a)if("glyph edit"===_UI.navhere)a.calcGlyphMaxes();else if("components"===_UI.navhere&&a){var b=a.usedin;if(b)for(var c=0;c<b.length;c++)getGlyph(b[c]).calcGlyphMaxes()}}function GlyphrProject(){this.projectsettings={version:_UI.thisGlyphrStudioVersion,versionnum:_UI.thisGlyphrStudioVersionNum,initialversionnum:_UI.thisGlyphrStudioVersionNum,projectid:!1,name:"My Font",upm:1e3,ascent:700,descent:-300,capheight:675,xheight:400,linegap:250,italicangle:0,griddivisions:10,overshoot:10,defaultlsb:20,defaultrsb:20,glyphrange:{basiclatin:!0,latinsuppliment:!1,latinextendeda:!1,latinextendedb:!1,custom:[],filternoncharpoints:!0},pointsize:7,spinnervaluechange:1,renderpointssnappedtogrid:!0,combineshapesonexport:!1,showkeyboardtipsicon:!0,stoppagenavigation:!0,formatsavefile:!0,showoutline:!1,showfill:!0,guides:{},snaptogrid:!1,snaptoguides:!1,colors:{glyphfill:"rgb(0,0,0)",glyphoutline:"rgb(0,0,0)",gridlightness:96,guide_dark:"rgb(204,81,0)",guide_med:"rgb(255,132,51)",guide_light:"rgb(255,193,153)"}},this.metadata={shared:"{{sectionbreak}}",font_family:"My Font",font_style:"normal",panose_1:"2 0 0 0 0 0 0 0 0 0",otf:"{{sectionbreak}}",designer:"",designerURL:"",manufacturer:"",manufacturerURL:"",license:"",licenseURL:"",version:"",description:"",copyright:"",trademark:"",svg:"{{sectionbreak}}",font_variant:"normal",font_weight:400,font_stretch:"normal",stemv:0,stemh:0,slope:0,underline_position:-50,underline_thickness:10,strikethrough_position:300,strikethrough_thickness:10,overline_position:750,overline_thickness:10},this.glyphs={},this.ligatures={},this.kerning={},this.components={}}function saveGlyphrProjectFile(){var a=cloneForSaveData(_GP);a=_GP.projectsettings.formatsavefile?json(a):JSON.stringify(a);var b=_GP.projectsettings.name+" - Glyphr Project - "+genDateStampSuffix()+".txt";saveFile(b,a),closeDialog(),setProjectAsSaved()}function cloneForSaveData(a){var b=a instanceof Array?[]:{};for(var c in a)"parentpath"!==c&&(b[c]=a[c]&&"object"==typeof a[c]?cloneForSaveData(a[c]):a[c]);return b}function genProjectID(){for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",b="g_",c=0;10>c;c++)b+=a.charAt(Math.floor(Math.round(Math.random()*a.length)));return b}function genDateStampSuffix(){var a=new Date,b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=(a.getMinutes()<10?"0":"")+a.getMinutes(),g=(a.getSeconds()<10?"0":"")+a.getSeconds();return""+b+"."+c+"."+d+"-"+e+"."+f+"."+g}function glyphIterator(a){var b=_GP.projectsettings.glyphrange,c="";if(b.basiclatin)for(var d=0;d<_UI.basiclatinorder.length;d++)c+=a(_UI.basiclatinorder[d]);if(b.latinsuppliment)for(var e=_UI.glyphrange.latinsuppliment.begin;e<=_UI.glyphrange.latinsuppliment.end;e++)c+=a(decToHex(e));if(b.latinextendeda)for(var f=_UI.glyphrange.latinextendeda.begin;f<=_UI.glyphrange.latinextendeda.end;f++)c+=a(decToHex(f));if(b.latinextendedb)for(var g=_UI.glyphrange.latinextendedb.begin;g<=_UI.glyphrange.latinextendedb.end;g++)c+=a(decToHex(g));if(b.custom.length)for(var h=0;h<b.custom.length;h++)for(var i=b.custom[h].begin;i<b.custom[h].end;i++)c+=a(decToHex(i));return c}function calcFontMaxes(){var a=_UI.fontmetrics;a.numglyphs=0,a.maxglyph=32,glyphIterator(function(b){a.numglyphs++,a.maxglyph=Math.max(a.maxglyph,b);var c=_GP.glyphs[b];c&&(c=c.maxes,a.maxes.xmax=Math.max(c.xmax,a.maxes.xmax),a.maxes.xmin=Math.min(c.xmin,a.maxes.xmin),a.maxes.ymax=Math.max(c.ymax,a.maxes.ymax),a.maxes.ymin=Math.min(c.ymin,a.maxes.ymin))})}function Guide(a){this.objtype="guide",this.type=a.type||"vertical",this.name=a.name||this.type+" guide",this.location=isval(a.location)?a.location:200,this.angle=a.angle||!1,this.color=a.color||makeRandomSaturatedColor(),this.visible=isval(a.visible)?a.visible:!0,this.showname=isval(a.showname)?a.showname:!0,this.editable=isval(a.editable)?a.editable:!0}function makeRandomSaturatedColor(){var a=51*Math.floor(5*Math.random()),b=[],c=Math.floor(3*Math.random());switch(b[c]=a,c){case 0:b[1]=0,b[2]=255;break;case 1:b[0]=0,b[2]=255;break;case 2:b[0]=255,b[1]=0}return"rgb("+b[0]+","+b[1]+","+b[2]+")"}function HKern(a){this.objtype="hkern",this.leftgroup=a.leftgroup||[],this.rightgroup=a.rightgroup||[],this.value=a.value||0}function getSelectedKern(){var a=_GP.kerning[_UI.selectedkern];return a||_GP.kerning[getFirstID(_GP.kerning)]||!1}function getSelectedKernID(){return _UI.selectedkern=_UI.selectedkern||getFirstID(_GP.kerning),_UI.selectedkern}function Path(a){if(a=a||{},this.objtype="path",this.pathpoints=[],a.pathpoints&&a.pathpoints.length)for(var b=0;b<a.pathpoints.length;b++)this.pathpoints[b]=new PathPoint(a.pathpoints[b]),this.pathpoints[b].parentpath=this;this.winding=isval(a.winding)?this.winding:this.getWinding(),this.maxes=a.maxes||clone(_UI.mins),this.segmentlengths=a.segmentlengths||[],this.pathpoints&&this.calcMaxes&&this.calcMaxes()}function findPathIntersections(a,b,c){function d(a,b,c,d){f=a.getSegment(b),g=c.getSegment(d),maxesOverlap(f.getFastMaxes(),g.getFastMaxes())&&h.push({bottom:f,top:g})}var e=[];if(e=e.concat(findPathPointIntersections(a,b,c)),e[0]&&c)return e[0];if(e=e.concat(findPathPointBoundaryIntersections(a,b,c)),e[0]&&c)return e[0];if(e=e.filter(function(a,b){return e.indexOf(a)===b}),!maxesOverlap(a.getMaxes(),b.getMaxes()))return e;for(var f,g,h=[],i=0;i<a.pathpoints.length;i++)for(var j=0;j<b.pathpoints.length;j++)d(a,i,b,j);for(var k=[],l=0;l<h.length;l++)if(k=findSegmentIntersections(h[l].bottom,h[l].top,0),k.length>0){if(c)return k[0];e=e.concat(k)}return e=e.filter(function(a,b){return e.indexOf(a)===b})}function findPathPointBoundaryIntersections(a,b){function c(a,b){for(var c,d=b.getMaxes(),e=0;e<a.pathpoints.length;e++)c=a.pathpoints[e],(c.P.x===d.xmin||c.P.x===d.xmax||c.P.y===d.ymin||c.P.y===d.ymax)&&b.isHere(sx_cx(c.P.x),sy_cy(c.P.y))&&re.push(""+c.P.x+"/"+c.P.y)}return re=[],c(a,b),c(b,a),re=re.filter(function(a,b){return re.indexOf(a)===b})}function findPathPointIntersections(a,b){for(var c=[],d=0;d<a.pathpoints.length;d++)for(var e=0;e<b.pathpoints.length;e++)pointsOverlap(a.pathpoints[d].P,b.pathpoints[e].P)&&c.push(""+a.pathpoints[d].P.x+"/"+a.pathpoints[d].P.y);return c=c.filter(function(a,b){return c.indexOf(a)===b})}function maxesOverlap(a,b){var c=a.xmin<b.xmax&&a.xmax>b.xmin&&a.ymin<b.ymax&&a.ymax>b.ymin;return c}function PathPoint(a){a=a||{},this.objtype="pathpoint",this.P=new Coord(a.P?a.P:{x:100,y:100}),this.H1=new Coord(a.H1?a.H1:{x:0,y:0}),this.H2=new Coord(a.H2?a.H2:{x:200,y:200}),this.type=a.type||"corner",this.useh1=isval(a.useh1)&&a.useh1?!0:!1,this.useh2=isval(a.useh2)&&a.useh2?!0:!1,"symmetric"===this.type?this.makeSymmetric("H1"):"flat"===this.type&&this.makeFlat("H1")}function pointsOverlap(a,b,c){c=c||3;var d=round(a.x,c),e=round(a.y,c),f=round(b.x,c),g=round(b.y,c),h=d===f&&e===g;return h}function makePathPointFromSegments(a,b){var c=new PathPoint({H1:new Coord({x:a.p3x,y:a.p3y}),P:new Coord({x:b.p1x,y:b.p1y}),H2:new Coord({x:b.p2x,y:b.p2y})});return c.resolvePointType(),c}function Coord(a){this.objtype="coord",a=a||{},this.x=parseFloat(a.x)||0,this.y=parseFloat(a.y)||0,this.xlock=a.xlock||!1,this.ylock=a.yllock||!1,a&&void 0!==a.x&&isNaN(a.x)&&console.log("NEW COORD >> initialized oa.x = "+a.x),a&&void 0!==a.y&&isNaN(a.y)&&console.log("NEW COORD >> initialized oa.y = "+a.y)}function PolySegment(a){a=a||{},this.objtype="polysegment",this.segments=a.segments||[]}function Segment(a){a=a||{},this.objtype="segment",this.p1x=numSan(a.p1x)||0,this.p1y=numSan(a.p1y)||0,this.p2x=numSan(a.p2x)||this.p1x||0,this.p2y=numSan(a.p2y)||this.p1y||0,this.p3x=numSan(a.p3x)||0,this.p3y=numSan(a.p3y)||0,this.p4x=numSan(a.p4x)||0,this.p4y=numSan(a.p4y)||0,a.p3x||(this.p3x=this.p4x),a.p3y||(this.p3y=this.p4y),this.line=this.isLine()}function checkXbounds(a,b){a.xmin>b?a.xmin=b:a.xmax<b&&(a.xmax=b)}function checkYbounds(a,b){a.ymin>b?a.ymin=b:a.ymax<b&&(a.ymax=b)}function getBezierValue(a,b,c,d,e){var f=1-a;return f*f*f*b+3*f*f*a*c+3*f*a*a*d+a*a*a*e}function findSegmentIntersections(a,b,c){if(c=c||0,0===c){var d=findOverlappingLineSegmentIntersections(a,b);if(d.length)return d}if(0===c){var e=findCrossingLineSegmentIntersections(a,b);if(e.length)return e}var f=a.getFastMaxes(),g=b.getFastMaxes();if(!maxesOverlap(f,g))return[];var h=1e-5,i=4,j=f.xmax-f.xmin,k=f.ymax-f.ymin,l=g.xmax-g.xmin,m=g.ymax-g.ymin;if(h>j&&h>k&&h>l&&h>m){j*=.5,k*=.5,l*=.5,m*=.5;var n=(f.xmin+j+(g.xmin+l))/2,o=(f.ymin+k+(g.ymin+m))/2;n=round(n,i),o=round(o,i);var p=""+n+"/"+o;return[p]}var q=[],r=a.split(),s=b.split(),t=[[r[0],s[0]],[r[0],s[1]],[r[1],s[1]],[r[1],s[0]]];return t=t.filter(function(a){return maxesOverlap(a[0].getFastMaxes(),a[1].getFastMaxes())}),t.forEach(function(a){q=q.concat(findSegmentIntersections(a[0],a[1],c+1))}),0===t.length?q:q=q.filter(function(a,b){return q.indexOf(a)===b
})}function findOverlappingLineSegmentIntersections(a,b){var c=[];return a.containsPointOnLine(b.getCoord(1))&&c.push(""+b.p1x+"/"+b.p1y),a.containsPointOnLine(b.getCoord(4))&&c.push(""+b.p4x+"/"+b.p4y),b.containsPointOnLine(a.getCoord(1))&&c.push(""+a.p1x+"/"+a.p1y),b.containsPointOnLine(a.getCoord(4))&&c.push(""+a.p4x+"/"+a.p4y),c.length,c}function findCrossingLineSegmentIntersections(a,b){if(!a.line||!b.line)return[];var c=a.p4x-a.p1x,d=a.p4y-a.p1y,e=b.p4x-b.p1x,f=b.p4y-b.p1y,g=(-1*d*(a.p1x-b.p1x)+c*(a.p1y-b.p1y))/(-1*e*d+c*f),h=(e*(a.p1y-b.p1y)-f*(a.p1x-b.p1x))/(-1*e*d+c*f);if(g>=0&&1>=g&&h>=0&&1>=h){var i=numSan(a.p1x+h*c),j=numSan(a.p1y+h*d);if(a.containsEndPoint({x:i,y:j})&&b.containsEndPoint({x:i,y:j}))return[];var k=[""+i+"/"+j];return k}return[]}function ixToCoord(a){return{x:parseFloat(a.split("/")[0]),y:parseFloat(a.split("/")[1])}}function segmentsAreEqual(a,b,c){if(c=isval(c)?c:1,round(a.p1x,c)===round(b.p1x,c)&&round(a.p1y,c)===round(b.p1y,c)&&round(a.p4x,c)===round(b.p4x,c)&&round(a.p4y,c)===round(b.p4y,c)){if(a.line&&b.line)return debug(" segmentsAreEqual - returning LINE true - END\n"),!0;if(round(a.p2x,c)===round(b.p2x,c)&&round(a.p2y,c)===round(b.p2y,c)&&round(a.p3x,c)===round(b.p3x,c)&&round(a.p3y,c)===round(b.p3y,c))return debug(" segmentsAreEqual - returning FULLY true - END\n"),!0}return!1}function pointsAreCollinear(a,b,c,d){d=isval(d)?d:3;var e=(b.x-a.x)*(c.y-a.y),f=(c.x-a.x)*(b.y-a.y);return round(e,d)===round(f,d)}function segmentsAreLinked(a,b,c){return c=isval(c)?c:1,round(a.p1x,c)===round(b.p4x,c)&&round(a.p1y,c)===round(b.p4y,c)||round(a.p4x,c)===round(b.p1x,c)&&round(a.p4y,c)===round(b.p1y,c)?!0:!1}function Shape(a){a=a||{},this.objtype="shape",this.name=a.name||"Shape",this.path=isval(a.path)?new Path(a.path):rectPathFromMaxes(!1),this.visible=isval(a.visible)?a.visible:!0,this.xlock=a.xlock||!1,this.ylock=a.ylock||!1,this.wlock=a.wlock||!1,this.hlock=a.hlock||!1,this.ratiolock=a.ratiolock||!1}function rectPathFromMaxes(a){var b=0,c=_GP.projectsettings.ascent,d=_GP.projectsettings.upm/_GP.projectsettings.griddivisions,e=0;a&&(b=a.xmin,c=a.ymax,d=a.xmax,e=a.ymin);var f=round((d-b)/4),g=round((c-e)/4),h=new Coord({x:b,y:c}),i=new Coord({x:b,y:c-g}),j=new Coord({x:b+f,y:c}),k=new Coord({x:d,y:c}),l=new Coord({x:d-f,y:c}),m=new Coord({x:d,y:c-g}),n=new Coord({x:d,y:e}),o=new Coord({x:d,y:e+g}),p=new Coord({x:d-f,y:e}),q=new Coord({x:b,y:e}),r=new Coord({x:b+f,y:e}),s=new Coord({x:b,y:e+g}),t=[];t[0]=new PathPoint({P:h,H1:i,H2:j}),t[1]=new PathPoint({P:k,H1:l,H2:m}),t[2]=new PathPoint({P:n,H1:o,H2:p}),t[3]=new PathPoint({P:q,H1:r,H2:s});var u=new Path({pathpoints:t,leftx:b,rightx:d,topy:c,bottomy:e});return u}function ovalPathFromMaxes(a){a=a||{},lx=a.xmin||0,ty=a.ymax||_GP.projectsettings.xheight||500,rx=a.xmax||_GP.projectsettings.xheight||500,by=a.ymin||0;var b=round((rx-lx)/2),c=round((ty-by)/2),d=round(.448*b),e=round(.448*c),f=new Coord({x:lx+b,y:ty}),g=new Coord({x:lx+d,y:ty}),h=new Coord({x:rx-d,y:ty}),i=new Coord({x:rx,y:by+c}),j=new Coord({x:rx,y:ty-e}),k=new Coord({x:rx,y:by-e}),l=new Coord({x:lx+b,y:by}),m=new Coord({x:rx-d,y:by}),n=new Coord({x:lx+d,y:by}),o=new Coord({x:lx,y:by+c}),p=new Coord({x:lx,y:by+e}),q=new Coord({x:lx,y:ty-e}),r=[];return r[0]=new PathPoint({P:f,H1:g,H2:h,type:"symmetric"}),r[1]=new PathPoint({P:i,H1:j,H2:k,type:"symmetric"}),r[2]=new PathPoint({P:l,H1:m,H2:n,type:"symmetric"}),r[3]=new PathPoint({P:o,H1:p,H2:q,type:"symmetric"}),new Path({pathpoints:r})}function addShape(a){a?"componentinstance"===a.objtype?_UI.selectedtool="shaperesize":a.path&&"shaperesize"===_UI.selectedtool:(a=new Shape({}),a.name="Rectangle "+(1*getSelectedWorkItemShapes().length+1));var b=getSelectedWorkItem();return b.shapes.push(a),_UI.ms.shapes.select(a),b.calcGlyphMaxes(),_UI.navprimaryhere="npAttributes",a}function addBasicShape(a){var b,c,d,e,f=50,g=500,h=300,i=new Shape({}),j=!1,k="Shape ";"oval"===a?(b=new PathPoint({P:new Coord({x:0,y:g/2}),H1:new Coord({x:0,y:f}),H2:new Coord({x:0,y:g-f}),type:"symmetric"}),c=new PathPoint({P:new Coord({x:h/2,y:g}),H1:new Coord({x:f,y:g}),H2:new Coord({x:h-f,y:g}),type:"symmetric"}),d=new PathPoint({P:new Coord({x:h,y:g/2}),H1:new Coord({x:h,y:g-f}),H2:new Coord({x:h,y:f}),type:"symmetric"}),e=new PathPoint({P:new Coord({x:h/2,y:0}),H1:new Coord({x:h-f,y:0}),H2:new Coord({x:f,y:0}),type:"symmetric"}),j=[b,c,d,e],k="Oval "):(b=new PathPoint({P:new Coord({x:0,y:0}),H1:new Coord({x:f,y:0}),H2:new Coord({x:0,y:f})}),c=new PathPoint({P:new Coord({x:0,y:g}),H1:new Coord({x:0,y:g-f}),H2:new Coord({x:f,y:g})}),d=new PathPoint({P:new Coord({x:h,y:g}),H1:new Coord({x:h-f,y:g}),H2:new Coord({x:h,y:g-f})}),e=new PathPoint({P:new Coord({x:h,y:0}),H1:new Coord({x:h,y:f}),H2:new Coord({x:h-f,y:0})}),j=[b,c,d,e],k="Rectangle "),i.path=new Path({pathpoints:j}),i.name=k+getSelectedWorkItemShapes().length+1,getSelectedWorkItemShapes().push(i),_UI.ms.shapes.select(i),updateCurrentGlyphWidth()}function turnSelectedShapeIntoAComponent(){var a=clone(_UI.ms.shapes.getMembers()),b=1===a.length?"Component "+a[0].name:"Component "+(getLength(_GP.components)+1);_UI.ms.shapes.deleteShapes();var c=createNewComponent(new Glyph({shapes:a,name:b}));insertComponentInstance(c),_UI.selectedtool="shaperesize",selectShape(getSelectedWorkItemShapes().length-1),redraw({calledby:"turnSelectedShapeIntoAComponent"})}function getClickedShape(a,b){for(var c,d=getSelectedWorkItemShapes(),e=d.length-1;e>=0;e--)if(c=d[e],c.isHere(a,b))return c;return!1}function isOverShape(a,b){for(var c=getSelectedWorkItemShapes(),d=c.length-1;d>=0;d--)if(c[d].isHere(a,b))return!0;return!1}function combineShapes(a,b,c){function d(a){for(var b=[],c={},d=0;d<a.pathpoints.length;d++){if(c=new PathPoint(a.pathpoints[d]),"overlap"===a.pathpoints[d].customid)return{points:b,overlap:c};b.push(c)}}function e(a){for(var b=[],c={},d=0;d<a.pathpoints.length;d++)if("overlap"===a.pathpoints[d].customid){c=new PathPoint(a.pathpoints[d]);for(var e=d+1;e<a.pathpoints.length;e++)b.push(new PathPoint(a.pathpoints[e]));return{points:b,overlap:c}}}var f=findPathIntersections(a.path,b.path);if(f.length<1)return c||showToast("The selected shapes do not have overlapping paths."),!1;var g=ixToCoord(f[0]),h=a.path.containsPoint(g);h||(h=a.path.getClosestPointOnCurve(g),h=a.path.insertPathPoint(h.split,h.point)),h.customid="overlap";var i=b.path.containsPoint(g);i||(i=b.path.getClosestPointOnCurve(g),i=b.path.insertPathPoint(i.split,i.point)),i.customid="overlap";var j=d(a.path),k=e(a.path),l=d(b.path),m=e(b.path),n=[];return n=n.concat(j.points),n.push(new PathPoint({P:clone(j.overlap.P),H1:clone(j.overlap.H1),H2:clone(l.overlap.H2),type:"corner",useh1:j.overlap.useh1,useh2:l.overlap.useh2})),n=n.concat(m.points),n=n.concat(l.points),n.push(new PathPoint({P:clone(l.overlap.P),H1:clone(l.overlap.H1),H2:clone(k.overlap.H2),type:"corner",useh1:l.overlap.useh1,useh2:k.overlap.useh2})),n=n.concat(k.points),[new Shape({path:new Path({pathpoints:n})})]}window.onload=_UI.coremode?coreMode_OnLoad:glyphrStudio_OnLoad,Number.prototype.makeCrisp=function(a){var b=a?1:-1;return round(this)+.5*b},ComponentInstance.prototype.getTransformedGlyph=function(){if(this.transformedglyphcache)return this.transformedglyphcache;var a,b=getGlyph(this.link,!0);return b?(a=new Glyph(clone(b)),this.rotatefirst&&a.rotate(rad(this.rotation,a.getCenter())),this.flipew&&a.flipEW(),this.flipns&&a.flipNS(),a.updateGlyphPosition(this.translatex,this.translatey,!0),a.updateGlyphSize(this.scalew,this.scaleh,!1),this.reversewinding&&a.reverseWinding(),this.rotatefirst||a.rotate(rad(this.rotation,a.getCenter())),this.transformedglyphcache=a,a):(console.warn("Tried to get Component: "+this.link+" but it doesn't exist - bad usedin array maintenance."),!1)},ComponentInstance.prototype.getName=function(){return this.name},ComponentInstance.prototype.changeShapeName=function(a){debug("\n ComponentInstance.changeShapeName - START"),debug("	 passed: "+a),a=strSan(a),debug("	 sanitized: "+a),""!==a?(this.name=a,history_put("component instance name")):showToast("Invalid component instance name - component instance names must only contain alphanumeric characters or spaces."),redraw({calledby:"ComponentInstance Name",redrawcanvas:!1}),debug(" ComponentInstance.changeShapeName - END\n")},ComponentInstance.prototype.updateShapePosition=function(a,b){a=parseFloat(a)||0,b=parseFloat(b)||0,this.translatex=1*this.translatex+a,this.translatey=1*this.translatey+b,this.changed()},ComponentInstance.prototype.setShapePosition=function(a,b,c){var d=getGlyph(this.link),e=a?1*a-d.maxes.xmin:0,f=b?1*b-d.maxes.ymax:0;this.updateShapePosition(e,f,c)},ComponentInstance.prototype.updateShapeSize=function(a,b,c){if(a!==!1&&(a=parseFloat(a)||0),b!==!1&&(b=parseFloat(b)||0),c){var d=this.getTransformedGlyph(),e=d.maxes.xmax-d.maxes.xmin,f=d.maxes.ymax-d.maxes.ymin;Math.abs(a)>Math.abs(b)?b=a*(f/e):a=b*(e/f)}this.scalew=1*this.scalew+a,this.scaleh=1*this.scaleh+b,0===this.rotation&&(this.rotatefirst=!1),this.changed()},ComponentInstance.prototype.setShapeSize=function(a,b,c){var d=getGlyph(this.link),e=nx?1*nx-d.maxes.xmin:0,f=ny?1*ny-d.maxes.ymax:0;this.updateShapePosition(e,f,c)},ComponentInstance.prototype.getWidth=function(){var a=this.getTransformedGlyph();return a.maxes.xmax-a.maxes.xmin},ComponentInstance.prototype.getHeight=function(){var a=this.getTransformedGlyph();return a.maxes.ymax-a.maxes.ymin},ComponentInstance.prototype.flipEW=function(a){if(this.flipew=!this.flipew,a){var b=this.getTransformedGlyph();this.translatex+=a-b.maxes.xmax+a-b.maxes.xmin}0===this.rotation&&(this.rotatefirst=!1),this.changed()},ComponentInstance.prototype.flipNS=function(a){if(this.flipns=!this.flipns,a){var b=this.getTransformedGlyph();this.translatey+=a-b.maxes.ymax+a-b.maxes.ymin}0===this.rotation&&(this.rotatefirst=!1),this.changed()},ComponentInstance.prototype.rotate=function(a){var b=deg(a);this.rotation=(this.rotation+b)%360,0!==this.scaleh||0!==this.scalew||this.flipew||this.flipns||(this.rotatefirst=!0),this.changed()},ComponentInstance.prototype.getCenter=function(){return this.getTransformedGlyph().getCenter()},ComponentInstance.prototype.getMaxes=function(){return this.getTransformedGlyph().maxes},ComponentInstance.prototype.calcMaxes=function(){return this.getTransformedGlyph().calcGlyphMaxes()},ComponentInstance.prototype.reverseWinding=function(){this.reversewinding=!this.reversewinding,this.changed()},ComponentInstance.prototype.drawShape=function(a,b){var c=this.getTransformedGlyph();if(!c)return!1;for(var d=!1,e=!1,f=0;f<c.shapes.length;f++)d=c.shapes[f].drawShape(a,b),e=e||!d;return!e},ComponentInstance.prototype.genPostScript=function(a,b){for(var c,d,e=this.getTransformedGlyph(),f=0;f<e.shapes.length;f++)d=e.shapes[f].genPostScript(a,b),a=d.lastx,b=d.lasty,c+=d.re;return{re:c,lastx:a,lasty:b}},ComponentInstance.prototype.makeOpenTypeJSpath=function(a){a=a||new opentype.Path;var b=this.getTransformedGlyph();return b.makeOpenTypeJSpath(a)},ComponentInstance.prototype.draw_PathOutline=function(a,b){a=a||_UI.colors.green,b=b||1;for(var c=this.getTransformedGlyph(),d=0;d<c.shapes.length;d++)draw_PathOutline(c.shapes[d],a,b)},ComponentInstance.prototype.draw_BoundingBox=function(a,b){a=a||_UI.colors.green,b=b||1;var c=this.getTransformedGlyph();draw_BoundingBox(c.maxes,a,b)},ComponentInstance.prototype.draw_BoundingBoxHandles=function(a,b){a=a||_UI.colors.green,b=b||1;var c=this.getTransformedGlyph();draw_BoundingBoxHandles(c.maxes,a,b)},ComponentInstance.prototype.isHere=function(a,b){var c=this.getTransformedGlyph();return c?c.isHere(a,b):!1},ComponentInstance.prototype.isOverBoundingBoxHandle=function(a,b){var c=isOverBoundingBoxHandle(a,b,this.getMaxes());return c},ComponentInstance.prototype.isOverControlPoint=function(){return!1},ComponentInstance.prototype.changed=function(){this.transformedglyphcache=!1},Glyph.prototype.setGlyphPosition=function(a,b,c){a!==!1&&(a=parseFloat(a)),b!==!1&&(b=parseFloat(b));var d=a?a-this.maxes.xmin:0,e=b?b-this.maxes.ymax:0;this.updateGlyphPosition(d,e,c)},Glyph.prototype.updateGlyphPosition=function(a,b,c){a=parseFloat(a)||0,b=parseFloat(b)||0;for(var d=this.shapes,e=0;e<d.length;e++)d[e].updateShapePosition(a,b,c);this.calcGlyphMaxes()},Glyph.prototype.setGlyphSize=function(a,b,c){a!==!1&&(a=parseFloat(a)),b!==!1&&(b=parseFloat(b));var d=this.maxes.ymax-this.maxes.ymin,e=this.maxes.xmax-this.maxes.xmin,f=a?a-e:0,g=b?b-d:0;c&&(Math.abs(b)>Math.abs(a)?f=e*(b/d)-e:g=d*(a/e)-d),this.updateGlyphSize(f,g,!1)},Glyph.prototype.updateGlyphSize=function(a,b,c){a!==!1&&(a=parseFloat(a)||0),b!==!1&&(b=parseFloat(b)||0);var d=this.maxes.xmax-this.maxes.xmin,e=this.maxes.ymax-this.maxes.ymin,f=d+a,g=e+b;Math.abs(f)<1&&(f=1),Math.abs(g)<1&&(g=1);var h=g/e,i=f/d;c&&(0!==a&&0===b?h=i:i=h);for(var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=this.shapes,y=0;y<x.length;y++)j=x[y],k=j.getMaxes(),l=k.xmax-k.xmin,p=l*i,t=0===i?!1:p-l,m=k.ymax-k.ymin,q=m*h,u=0===h?!1:q-m,j.updateShapeSize(t,u,!1),n=k.xmin-this.maxes.xmin,r=n*i,v=0===i?!1:r-n,o=k.ymin-this.maxes.ymin,s=o*h,w=0===h?!1:s-o,j.updateShapePosition(v,w,!0);this.calcGlyphMaxes()},Glyph.prototype.flipEW=function(a){a=a||(this.maxes.xmax-this.maxes.xmin)/2+this.maxes.xmin;for(var b=0;b<this.shapes.length;b++)this.shapes[b].flipEW(a)},Glyph.prototype.flipNS=function(a){a=a||(this.maxes.ymax-this.maxes.ymin)/2+this.maxes.ymin;for(var b=0;b<this.shapes.length;b++)this.shapes[b].flipNS(a)},Glyph.prototype.rotate=function(a,b){b=b||this.getCenter();for(var c=0;c<this.shapes.length;c++)this.shapes[c].rotate(a,b);this.calcGlyphMaxes()},Glyph.prototype.getCenter=function(){var a=this.calcGlyphMaxes(),b={};return b.x=(a.xmax-a.xmin)/2+a.xmin,b.y=(a.ymax-a.ymin)/2+a.ymin,b},Glyph.prototype.reverseWinding=function(){for(var a=0;a<this.shapes.length;a++)this.shapes[a].reverseWinding()},Glyph.prototype.getName=function(){return this.name},Glyph.prototype.getLSB=function(){return this.leftsidebearing===!1?_GP.projectsettings.defaultlsb:this.leftsidebearing},Glyph.prototype.getRSB=function(){return this.rightsidebearing===!1?_GP.projectsettings.defaultrsb:this.rightsidebearing},Glyph.prototype.calcGlyphMaxes=function(){if(this.maxes=clone(_UI.mins),this.shapes.length>0)for(var a=0;a<this.shapes.length;a++)this.maxes=getOverallMaxes([this.shapes[a].getMaxes(),this.maxes]);else this.maxes={xmax:0,xmin:0,ymax:0,ymin:0};return this.calcGlyphWidth(),this.maxes},Glyph.prototype.calcGlyphWidth=function(){this.isautowide&&(this.glyphwidth=Math.max(this.maxes.xmax,0))},Glyph.prototype.getTotalWidth=function(){return this.calcGlyphWidth(),this.isautowide?this.glyphwidth+this.getLSB()+this.getRSB():this.glyphwidth},Glyph.prototype.canAddComponent=function(a){var b=""+getMyID(this);if(b===a)return!1;if(0===this.usedin.length)return!0;var c=this.collectAllDownstreamLinks([],!0);c=c.filter(function(a,b){return c.indexOf(a)===b});var d=this.collectAllUpstreamLinks([]);return d=d.filter(function(a,b){return d.indexOf(a)===b}),c.indexOf(a)>-1?!1:d.indexOf(a)>-1?!1:!0},Glyph.prototype.collectAllDownstreamLinks=function(a,b){a=a||[];for(var c=0;c<this.shapes.length;c++)"componentinstance"===this.shapes[c].objtype&&(a=a.concat(getGlyph(this.shapes[c].link).collectAllDownstreamLinks(a)),b||a.push(this.shapes[c].link));return a},Glyph.prototype.collectAllUpstreamLinks=function(a){a=a||[];for(var b=0;b<this.usedin.length;b++)a=a.concat(getGlyph(this.usedin[b]).collectAllUpstreamLinks(a)),a.push(this.usedin[b]);return a},Glyph.prototype.deleteLinks=function(a){for(var b,c=0;c<this.usedin.length;c++){b=getGlyph(this.usedin[c]);for(var d=0;d<b.shapes.length;d++)"componentinstance"===b.shapes[d].objtype&&b.shapes[d].link===a&&(b.shapes.splice(d,1),d--)}for(var e=0;e<this.shapes.length;e++)"componentinstance"===this.shapes[e].objtype&&removeFromUsedIn(this.shapes[e].link,a)},Glyph.prototype.drawGlyph=function(a,b,c,d){{var e,f,g=this.shapes;c?this.getLSB():0}d=d||1,a.beginPath();for(var h=0;h<g.length;h++)if(e=g[h],e.visible&&(f=e.drawShape(a,b),!f&&(console.warn("Could not draw shape "+e.name+" in Glyph "+this.name),"componentinstance"===e.objtype&&!getGlyph(e.link)))){console.warn(">>> Component Instance has bad link: "+e.link);var i=this.shapes.indexOf(e);i>-1&&(this.shapes.splice(i,1),console.warn(">>> Deleted the Instance"))}return a.fillStyle=_GP.projectsettings.colors.glyphfill,a.globalAlpha=d,a.closePath(),a.fill("nonzero"),a.globalAlpha=1,this.getTotalWidth()*b.dz},Glyph.prototype.makeSVG=function(a,b){var c=_GP.projectsettings;a=a||_UI.thumbsize,b=b||_UI.thumbgutter;var d=Math.max(c.upm,c.ascent-c.descent),e=Math.abs(c.descent),f=(a-2*b)/a,g=b/a*d,h=d-2*b,i=this.makeSVGpathData(),j='<svg version="1.1" ';return j+='xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" ',j+='width="'+a+'" height="'+a+'" viewBox="0,0,'+h+","+h+'">',j+='<g transform="translate('+g+","+(d-e-g/2)+") scale("+f+",-"+f+')">',j+='<path d="'+i+'"/>',j+="</g>",j+="</svg>"},Glyph.prototype.makeSVGpathData=function(){if(this.svg)return this.svg;for(var a,b,c,d=this.shapes,e="",f=this.getLSB(),g=0;g<d.length;g++)a=d[g],a.visible&&("componentinstance"===a.objtype?(c=a.getTransformedGlyph(),c&&(e+=c.makeSVGpathData())):(b=a.getPath(),b.updatePathPosition(f,0,!0),e+=b.makeSVGpathData("Glyph "+this.name+" Shape "+a.name),g<d.length-1&&(e+=" ")));return""===trim(e)&&(e="M0,0Z"),this.svg=e,e},Glyph.prototype.makeOpenTypeJSpath=function(a){a=a||new opentype.Path;for(var b=0;b<this.shapes.length;b++)a=this.shapes[b].makeOpenTypeJSpath(a);return a},Glyph.prototype.draw_MultiSelectAffordances=function(){for(var a=[],b=0;b<this.shapes.length;b++)"componentinstance"!==this.shapes[b].objtype&&(a=a.concat(this.shapes[b].path.pathpoints),this.shapes[b].draw_PathOutline(_UI.colors.blue,1));draw_PathPoints(a,_UI.colors.blue)},Glyph.prototype.isOverControlPoint=function(a,b,c){for(var d=!1,e=0;e<this.shapes.length;e++)if("componentinstance"!==this.shapes[e].objtype&&(d=this.shapes[e].path.isOverControlPoint(a,b,c)))return d;return!1},Glyph.prototype.flattenGlyph=function(){for(var a,b,c=[],d=0;d<this.shapes.length;d++)a=this.shapes[d],"shape"===a.objtype?c.push(clone(a)):"componentinstance"===a.objtype&&(b=a.getTransformedGlyph(),b=b.flattenGlyph(),c=c.concat(b.shapes));return this.shapes=c,this.calcGlyphMaxes(),this},Glyph.prototype.combineAllShapes=function(a){function b(b){for(var c,d=[],e=!1,f=0;f<b.length;f++)for(var g=0;g<b.length;g++)f!==g&&b[f]&&b[g]&&(c=combineShapes(b[f],b[g],a),c!==!1&&(d=d.concat(c),e=!0,b[f]=!1,b[g]=!1));return d=d.concat(b.filter(function(a){return a})),{arr:d,didstuff:e}}var c=[],d=[];if(1===this.shapes.length)return debug(this.name+" 		 "+this.shapes.length),this;if(2===this.shapes.length&&(c=combineShapes(this.shapes[0],this.shapes[1],a),!c))return debug(this.name+" 		 "+this.shapes.length),this;if(this.shapes.length>2){c=clone(this.shapes),c.sort(function(a,b){return a.path.getWinding()-b.path.getWinding()});for(var e=!0,f=0;e&&8>f;)e=!1,lr=b(c),e=lr.didstuff,c=lr.arr,f++}for(var g=0;g<c.length;g++)d=d.concat(c[g].resolveSelfOverlaps());return this.shapes=d,this.calcGlyphMaxes(),debug(this.name+" 		 "+this.shapes.length),this},Glyph.prototype.changed=function(){this.svg=!1;for(var a=0;a<this.shapes.length;a++)this.shapes[a].changed()},Glyph.prototype.map=function(a){a=a||"   ";for(var b,c=a+"GLYPH "+this.name+"\n",d=0;d<this.shapes.length;d++)b=this.shapes[d],"shape"===b.objtype?c+=a+"-"+d+"-"+b.name+" "+json(b.path.maxes,!0)+"\n":"componentinstance"===b.objtype&&(c+=a+"~"+d+"~"+b.name+"\n",c+=getGlyph(b.link).map(a+"   "));return c},Glyph.prototype.sendShapesTo=function(a){var b=getGlyph(a,!0);b.shapes=clone(b.shapes.concat(this.shapes)),b.calcGlyphMaxes();for(var c=0;c<this.shapes.length;c++)"componentinstance"===this.shapes[c].objtype&&addToUsedIn(this.shapes[c].link,a)},Glyph.prototype.isHere=function(a,b){for(var c=0;c<this.shapes.length;c++)if(this.shapes[c].isHere(a,b))return!0;return!1},Glyph.prototype.hasShapes=function(){for(var a,b=0;b<this.shapes.length;b++){if("componentinstance"!==this.shapes[b].objtype)return!0;if(a=this.shapes[b].getTransformedGlyph(),a.hasShapes())return!0}return!1},Guide.prototype.draw=function(a){if(this.visible){a=1*a;var b,c=_UI.glypheditctx,d=_UI.glypheditcanvassize,e=getView("guide"),f={x:0,y:0},g={x:0,y:0},h={x:0,y:0},i=5;"horizontal"===this.type?(b=(e.dy-this.location*e.dz).makeCrisp(),a&&(b+=a*e.dz),f.x=0,f.y=b,g.x=d,g.y=b,h.x=25,h.y=b-i):"vertical"===this.type&&(b=(e.dx-this.location*e.dz*-1).makeCrisp(),a&&(b+=a*e.dz),f.x=b,f.y=0,g.x=b,g.y=d,h.x=b+i,h.y=15),c.strokeStyle=this.color,isval(a)&&(c.strokeStyle=shiftColor(this.color,.6,!0)),c.beginPath(),c.moveTo(f.x,f.y),c.lineTo(g.x,g.y),c.stroke(),c.closePath(),this.showname&&_UI.showguidelabels&&!a&&(_UI.glypheditctx.fillStyle=this.color,_UI.glypheditctx.font="10px tahoma, verdana, sans-serif",_UI.glypheditctx.fillText(this.name,h.x,h.y))}},HKern.prototype.getName=function(){var a=hexToGlyph(this.leftgroup.join("")),b=hexToGlyph(this.rightgroup.join(""));return""+a+" | "+b},Path.prototype.setPathSize=function(a,b,c){a!==!1&&(a=parseFloat(a)),b!==!1&&(b=parseFloat(b));var d=a!==!1?a-this.getWidth():0,e=b!==!1?b-this.getHeight():0;this.updatePathSize(d,e,c)},Path.prototype.updatePathSize=function(a,b,c){if(a=parseFloat(a)||0,b=parseFloat(b)||0,a||b){if(c&&a!==b){var d=this.getWidth()/this.getHeight();Math.abs(a)>Math.abs(b)?b=a/d:a=b*d}var e=this.getWidth();0===e&&(e=1);var f=this.getHeight();0===f&&(f=1);var g=Math.max(e+a,1),h=Math.max(f+b,1),i=h/f,j=g/e;if(!c||!(1>=g||1>=h)){for(var k=0;k<this.pathpoints.length;k++){var l=this.pathpoints[k];l.P.x=(l.P.x-this.maxes.xmin)*j+this.maxes.xmin,l.H1.x=(l.H1.x-this.maxes.xmin)*j+this.maxes.xmin,l.H2.x=(l.H2.x-this.maxes.xmin)*j+this.maxes.xmin,l.P.y=(l.P.y-this.maxes.ymin)*i+this.maxes.ymin,l.H1.y=(l.H1.y-this.maxes.ymin)*i+this.maxes.ymin,l.H2.y=(l.H2.y-this.maxes.ymin)*i+this.maxes.ymin}this.checkForNaN(),this.calcMaxes()}}},Path.prototype.setPathPosition=function(a,b,c){a!==!1&&(a=parseFloat(a)),b!==!1&&(b=parseFloat(b));var d=a!==!1?1*a-this.maxes.xmin:0,e=b!==!1?1*b-this.maxes.ymax:0;this.updatePathPosition(d,e,c)},Path.prototype.updatePathPosition=function(a,b,c){c=isval(c)?c:!1,a!==!1&&(a=parseFloat(a)||0),b!==!1&&(b=parseFloat(b)||0);for(var d=0;d<this.pathpoints.length;d++){var e=this.pathpoints[d];e.updatePathPointPosition("P",a,b,c)}this.calcMaxes()},Path.prototype.getWinding=function(){return isval(this.winding)?this.winding:void(this.findWinding?this.findWinding():this.winding=0)},Path.prototype.getHeight=function(){var a=this.maxes.ymax-this.maxes.ymin;return Math.max(a,0)},Path.prototype.getWidth=function(){var a=this.maxes.xmax-this.maxes.xmin;return Math.max(a,0)},Path.prototype.getMaxes=function(){return clone(this.maxes)},Path.prototype.rotate=function(a,b){for(var c=0;c<this.pathpoints.length;c++){var d=this.pathpoints[c];d.rotate(a,b)}this.calcMaxes()},Path.prototype.isHere=function(a,b){var c=_UI.ishereghostctx;c.clearRect(0,0,_UI.glypheditcanvassize,_UI.glypheditcanvassize),c.fillStyle="rgba(0,0,255,0.2)",c.beginPath(),this.drawPath(c),c.closePath(),c.fill();var d=c.getImageData(a,b,1,1);return d.data[3]>0},Path.prototype.getNextPointNum=function(a){return a=parseInt(a)||0,a+=1,a%=this.pathpoints.length},Path.prototype.getPreviousPointNum=function(a){return a=parseInt(a)||0,a-=1,0>a&&(a+=this.pathpoints.length),a},Path.prototype.changed=function(){},Path.prototype.addPointsAtPathIntersections=function(){var a=this.getPolySegment();a.splitSegmentsAtIntersections();var b=a.getPath();this.pathpoints=clone(b.pathpoints)},Path.prototype.containsPoint=function(a,b){for(var c=0;c<this.pathpoints.length;c++)if(pointsOverlap(a,this.pathpoints[c].P)){if(!b)return this.pathpoints[c];b=!1}return!1},Path.prototype.drawPath=function(a,b){var c=_GP.projectsettings.renderpointssnappedtogrid,d=getView("Path.drawPath");if(b=b||clone(d),setView(b),!(this.pathpoints===!1||this.pathpoints.length<2)){var e,f,g,h,i,j,k,l;c?a.moveTo(sx_cx(round(this.pathpoints[0].P.x)),sy_cy(round(this.pathpoints[0].P.y))):a.moveTo(sx_cx(this.pathpoints[0].P.x),sy_cy(this.pathpoints[0].P.y));for(var m=0;m<this.pathpoints.length;m++)e=this.pathpoints[m],f=this.pathpoints[this.getNextPointNum(m)],"symmetric"===e.type?e.makeSymmetric("H1"):"flat"===e.type&&e.makeFlat("H1"),c?(g=sx_cx(round(e.getH2x())),h=sy_cy(round(e.getH2y())),i=sx_cx(round(f.getH1x())),j=sy_cy(round(f.getH1y())),k=sx_cx(round(f.P.x)),l=sy_cy(round(f.P.y))):(g=sx_cx(e.getH2x()),h=sy_cy(e.getH2y()),i=sx_cx(f.getH1x()),j=sy_cy(f.getH1y()),k=sx_cx(f.P.x),l=sy_cy(f.P.y)),a.bezierCurveTo(g,h,i,j,k,l);setView(d)}},Path.prototype.genPathPostScript=function(a,b){if(!this.pathpoints)return{re:"",lastx:a,lasty:b};for(var c,d,e,f,g,h,i,j,k="",l="				"+(this.pathpoints[0].P.x-a)+" "+(this.pathpoints[0].P.y-b)+" rmoveto \n",m=0;m<this.pathpoints.length;m++)c=this.pathpoints[m],d=this.pathpoints[this.getNextPointNum(m)],e=c.getH2x()-c.P.x,f=c.getH2y()-c.P.y,g=d.getH1x()-c.getH2x(),h=d.getH1y()-c.getH2y(),i=d.P.x-d.getH1x(),j=d.P.y-d.getH1y(),k="				"+e+" "+f+" "+g+" "+h+" "+i+" "+j+" rrcurveto \n",l+=k;return{re:l,lastx:d.P.x,lasty:d.P.y}},Path.prototype.makeSVGpathData=function(a){if(a=a||"not specified",!this.pathpoints)return"";re="";var b,c,d="";re+="M"+this.pathpoints[0].getPx()+","+this.pathpoints[0].getPy(),re.indexOf("NaN")>-1&&console.warn(a+" PathPoint 0 MOVE has NaN: "+re);for(var e=0;e<this.pathpoints.length;e++)b=this.pathpoints[e],c=this.pathpoints[this.getNextPointNum(e)],d=" C"+round(b.getH2x(),9)+","+round(b.getH2y(),9)+","+round(c.getH1x(),9)+","+round(c.getH1y(),9)+","+round(c.getPx(),9)+","+round(c.getPy(),9),d.indexOf("NaN")>-1&&console.warn(a+" PathPoint "+e+" has NaN: "+d),re+=d;return re+="Z"},Path.prototype.makeOpenTypeJSpath=function(a){a=a||new opentype.Path;var b,c;if(!this.pathpoints)return a.close(),a;a.moveTo(round(this.pathpoints[0].P.x),round(this.pathpoints[0].P.y));for(var d=0;d<this.pathpoints.length;d++)b=this.pathpoints[d],c=this.pathpoints[this.getNextPointNum(d)],a.curveTo(round(b.getH2x()),round(b.getH2y()),round(c.getH1x()),round(c.getH1y()),round(c.P.x),round(c.P.y));return a.close(),a},Path.prototype.getSegment=function(a){a=a||0,a%=this.pathpoints.length;var b=this.pathpoints[a],c=this.pathpoints[this.getNextPointNum(a)],d=new Segment({p1x:b.P.x,p1y:b.P.y,p2x:b.getH2x(),p2y:b.getH2y(),p3x:c.getH1x(),p3y:c.getH1y(),p4x:c.P.x,p4y:c.P.y});return d},Path.prototype.getPolySegment=function(){for(var a=[],b=0;b<this.pathpoints.length;b++)a.push(this.getSegment(b));return new PolySegment({segments:a})},Path.prototype.isOverControlPoint=function(a,b,c){for(var d=this.pathpoints||[],e=!1,f=d.length-1;f>=0;f--)if(e=d[f].isOverControlPoint(a,b,c))return e;return!1},Path.prototype.isOverFirstPoint=function(a,b){var c=this.pathpoints[0],d=_GP.projectsettings.pointsize/getView("Path.isOverFirstPoint").dz;return c&&c.P.x+d>a&&c.P.x-d<a&&c.P.y+d>b&&c.P.y-d<b?!0:!1},Path.prototype.findWinding=function(a){var b,c,d,e=-1,f=this.pathpoints;if(2===f.length)e=f[1].P.x>f[0].P.x?-1:1;else if(f.length>2)for(var g=0;g<f.length;g++)b=(g+1)%f.length,c=(g+2)%f.length,d=(f[b].P.x-f[g].P.x)*(f[c].P.y-f[b].P.y),d-=(f[b].P.y-f[g].P.y)*(f[c].P.x-f[b].P.x),0>d?e--:d>0&&e++;return 0!==e||a||(this.reverseWinding(),e=-1*this.findWinding(!0),this.reverseWinding()),this.winding=e,e},Path.prototype.reverseWinding=function(){var a,b;if(this.pathpoints){for(var c=0;c<this.pathpoints.length;c++)b=this.pathpoints[c],a=b.H1,b.H1=b.H2,b.H2=a,b.useh1!==b.useh2&&(b.useh1=!b.useh1,b.useh2=!b.useh2);this.pathpoints.reverse(),this.winding*=-1,0===this.winding&&this.findWinding(!0)}},Path.prototype.flipNS=function(a){var b=this.maxes.ymax;a=a||this.getHeight()/2+this.maxes.ymin;for(var c=0;c<this.pathpoints.length;c++){var d=this.pathpoints[c];d.P.y+=2*(a-d.P.y),d.H1.y+=2*(a-d.H1.y),d.H2.y+=2*(a-d.H2.y)}this.setPathPosition(!1,b),this.reverseWinding()},Path.prototype.flipEW=function(a){var b=this.maxes.xmin;a=a||this.getWidth()/2+this.maxes.xmin;for(var c=0;c<this.pathpoints.length;c++){var d=this.pathpoints[c];d.P.x+=2*(a-d.P.x),d.H1.x+=2*(a-d.H1.x),d.H2.x+=2*(a-d.H2.x)}this.setPathPosition(b,!1),this.reverseWinding()},Path.prototype.addPathPoint=function(a,b){var c=!1;if(a)a.parentpath=this,this.pathpoints.push(a),c=this.selectPathPoint(this.pathpoints.length-1);else if(a=new PathPoint,a.parentpath=this,a.H1.x=a.P.x,a.H1.y=a.P.y-100,a.H2.x=a.P.x+100,a.H2.y=a.P.y,b){if(this.pathpoints.length>0){var d=this.pathpoints[0];a.P.x=d.P.x-200,a.P.y=d.P.y-200}this.pathpoints.unshift(a),c=this.selectPathPoint(0)}else{if(this.pathpoints.length>0){var e=this.pathpoints[this.pathpoints.length-1];a.P.x=e.P.x+200,a.P.y=e.P.y+200}this.pathpoints.push(a),c=this.selectPathPoint(this.pathpoints.length-1)}return this.findWinding(),this.calcMaxes(),c},Path.prototype.insertPathPoint=function(a,b){var c,d,e,f,g=b||0,h=g===!1?this.pathpoints[0]:this.pathpoints[g],i=this.getNextPointNum(g),j=this.pathpoints[i];if(this.pathpoints.length>1){var k=this.getSegment(g).split(a),l=k[0],m=k[1];c=new Coord({x:l.p4x,y:l.p4y}),d=new Coord({x:l.p3x,y:l.p3y}),e=new Coord({x:m.p2x,y:m.p2y}),f=new PathPoint({P:c,H1:d,H2:e,type:"flat",useh1:!0,useh2:!0}),f.round(),"symmetric"===h.type&&(h.type="flat"),h.H2.x=l.p2x,h.H2.y=l.p2y,h.round(),"symmetric"===j.type&&(j.type="flat"),j.H1.x=m.p3x,j.H1.y=m.p3y,j.round()}else{var n=100;c=new Coord({x:h.P.x+n,y:h.P.y+n}),d=new Coord({x:h.getH2x()+n,y:h.getH2y()+n}),e=new Coord({x:h.getH1x()+n,y:h.getH1y()+n}),f=new PathPoint({P:c,H1:d,H2:e,type:h.type})}return f.parentpath=this,this.pathpoints.splice(i,0,f),this.calcMaxes(),f},Path.prototype.getClosestPointOnCurve=function(a,b){for(var c,d,e=1e4,f=!1,g=!1,h=999999999,i=0;i<this.pathpoints.length;i++){e=100*this.segmentlengths[i];for(var j=0;1>j;j+=1/e)c=this.getCoordFromSplit(j,i),d=Math.sqrt((c.x-a.x)*(c.x-a.x)+(c.y-a.y)*(c.y-a.y)),h>d&&(f&&f.point!==i&&(g=clone(f)),h=d,f={point:i,split:j,distance:d,x:c.x,y:c.y})}return b?g:f},Path.prototype.getCoordFromSplit=function(a,b){if(this.pathpoints.length>1){var c=this.getSegment(b);return c.getCoordFromSplit(a)}return this.pathpoints[0].P},Path.prototype.selectPathPoint=function(a){return a=parseInt(a),a===!1?!1:(a=-1===a?this.pathpoints.length-1:Math.abs(a),a%=this.pathpoints.length,_UI.ms.points.select(this.pathpoints[a]),this.pathpoints[a])},Path.prototype.calcMaxes=function(){this.maxes=clone(_UI.mins);for(var a,b,c=0;c<this.pathpoints.length;c++)a=this.getSegment(c),b=a.getMaxes(),this.maxes=getOverallMaxes([this.maxes,b]),this.segmentlengths[c]=a.getLength();this.maxes.xmax=round(this.maxes.xmax,4),this.maxes.xmin=round(this.maxes.xmin,4),this.maxes.ymax=round(this.maxes.ymax,4),this.maxes.ymin=round(this.maxes.ymin,4)},Path.prototype.validate=function(){for(var a,b=0;b<this.pathpoints.length;b++)a=this.pathpoints[b],a.P.x||0===a.P.x||(a.P.x=0),a.P.y||0===a.P.y||(a.P.y=0),a.H1.x||0===a.H1.x||(a.H1.x=0),a.H1.y||0===a.H1.y||(a.H1.y=0),a.H2.x||0===a.H2.x||(a.H2.x=0),a.H2.y||0===a.H2.y||(a.H2.y=0),a.roundAll()},Path.prototype.checkForNaN=function(){for(var a=0;a<this.pathpoints.length;a++){var b=this.pathpoints[a];if(isNaN(b.P.x)||isNaN(b.P.y)||isNaN(b.H1.x)||isNaN(b.H1.y)||isNaN(b.H2.x)||isNaN(b.H2.y))return!0}return!1},PathPoint.prototype.setPathPointPosition=function(a,b,c){var d=0,e=0;b!==!1&&(b=parseFloat(b)),c!==!1&&(c=parseFloat(c));var f=!1;switch(a){case"P":this.P.xlock||isNaN(b)||(d=this.P.x-b,this.P.x=b,this.H1.x-=d,this.H2.x-=d),this.P.ylock||isNaN(c)||(e=this.P.y-c,this.P.y=c,this.H1.y-=e,this.H2.y-=e);break;case"H1":this.H1.xlock||isNaN(b)||(this.H1.x=b,f="H1"),this.H1.ylock||isNaN(c)||(this.H1.y=c,f="H1");break;case"H2":this.H2.xlock||isNaN(b)||(this.H2.x=b,f="H2"),this.H2.ylock||isNaN(c)||(this.H2.y=c,f="H2")}f&&("symmetric"===this.type?this.makeSymmetric(f):"flat"===this.type&&this.makeFlat(f))},PathPoint.prototype.updatePathPointPosition=function(a,b,c,d){b!==!1&&(b=parseFloat(b)),c!==!1&&(c=parseFloat(c));var e="pathedit"===_UI.selectedtool?this.P.xlock:!1,f="pathedit"===_UI.selectedtool?this.P.ylock:!1;
switch(isval(d)&&d&&(e=!1,f=!1),a){case"P":e||(this.P.x+=b),f||(this.P.y+=c),e||(this.H1.x+=b),f||(this.H1.y+=c),e||(this.H2.x+=b),f||(this.H2.y+=c);break;case"H1":this.H1.x+=b,this.H1.y+=c,"symmetric"===this.type?this.makeSymmetric("H1"):"flat"===this.type&&this.makeFlat("H1");break;case"H2":this.H2.x+=b,this.H2.y+=c,"symmetric"===this.type?this.makeSymmetric("H2"):"flat"===this.type&&this.makeFlat("H2")}},PathPoint.prototype.isOverControlPoint=function(a,b,c){var d=_GP.projectsettings.pointsize/getView("Path.isOverControlPoint").dz;return this.P.x+d>a&&this.P.x-d<a&&this.P.y+d>b&&this.P.y-d<b?{point:this,type:"P"}:this.useh1&&!c&&this.H1.x+d>a&&this.H1.x-d<a&&this.H1.y+d>b&&this.H1.y-d<b?{point:this,type:"H1"}:this.useh2&&!c&&this.H2.x+d>a&&this.H2.x-d<a&&this.H2.y+d>b&&this.H2.y-d<b?{point:this,type:"H2"}:!1},PathPoint.prototype.toggleUseHandle=function(a){"H1"===a?(this.useh1=!this.useh1,history_put("Use Handle 1 : "+this.useh1)):(this.useh2=!this.useh2,history_put("Use Handle 2 : "+this.useh2)),_UI.ms.shapes.calcMaxes(),redraw({calledby:"pointDetails"})},PathPoint.prototype.setPointType=function(a){"symmetric"===a?this.makeSymmetric():"flat"===a?this.makeFlat():this.type="corner"},PathPoint.prototype.makeSymmetric=function(a){if(!a&&(a=this.useh1?"H1":"H2",!this.useh1&&!this.useh2&&(this.H2.x+this.P.x+this.H1.x)/3===this.P.x&&(this.H2.y+this.P.y+this.H1.y)/3===this.P.y))return this.H2.x-=200,this.H1.x+=200,this.type="symmetric",this.useh1=!0,void(this.useh2=!0);switch(a){case"H1":this.H2.x=this.P.x-this.H1.x+this.P.x,this.H2.y=this.P.y-this.H1.y+this.P.y;break;case"H2":this.H1.x=this.P.x-this.H2.x+this.P.x,this.H1.y=this.P.y-this.H2.y+this.P.y}this.type="symmetric",this.useh1=!0,this.useh2=!0},PathPoint.prototype.makeFlat=function(a){if(this.isFlat())return void(this.type="flat");if(!a&&(a=this.useh1?"H1":"H2",!this.useh1&&!this.useh2&&(this.H2.x+this.P.x+this.H1.x)/3===this.P.x&&(this.H2.y+this.P.y+this.H1.y)/3===this.P.y))return this.H2.x-=300,this.H1.x+=100,this.type="flat",this.useh1=!0,void(this.useh2=!0);var b,c,d,e,f=this.getH1Angle(),g=this.getH2Angle(),h=this.getH1Length(),i=this.getH2Length();"H1"===a?(d=Math.cos(f)*i,e=Math.tan(f)*d,b=this.P.x+-1*d,c=this.P.y+-1*e,isNaN(b)||isNaN(c)||(this.H2.x=b,this.H2.y=c)):"H2"===a&&(d=Math.cos(g)*h,e=Math.tan(g)*d,b=this.P.x+-1*d,c=this.P.y+-1*e,isNaN(b)||isNaN(c)||(this.H1.x=b,this.H1.y=c)),this.type="flat"},PathPoint.prototype.isFlat=function(){if(this.P.x===this.H1.x&&this.P.x===this.H2.x)return!0;if(this.P.y===this.H1.y&&this.P.y===this.H2.y)return!0;var a=this.getH1Angle(),b=this.getH2Angle();return 3.14===round(Math.abs(a)+Math.abs(b),2)},PathPoint.prototype.resolvePointType=function(){this.type=this.isFlat()?this.getH1Length()===this.getH2Length()?"symmetric":"flat":"corner"},PathPoint.prototype.makePointedTo=function(a,b,c){var d=this.P.x-a,e=this.P.y-b,f=Math.sqrt(d*d+e*e),g=Math.acos(d/f);this.H1.x=this.P.x-Math.cos(g)*c,this.H1.y=this.P.y-Math.sin(g)*c,"corner"===this.type?this.makeFlat("H1"):this.makeSymmetric("H1")},PathPoint.prototype.round=function(a){a=a||3,this.P.x=round(this.P.x,a),this.P.y=round(this.P.y,a),this.H1.x=round(this.H1.x,a),this.H1.y=round(this.H1.y,a),this.H2.x=round(this.H2.x,a),this.H2.y=round(this.H2.y,a)},PathPoint.prototype.rotate=function(a,b){rotate(this.P,a,b),rotate(this.H1,a,b),rotate(this.H2,a,b)},PathPoint.prototype.resetHandles=function(){this.type="corner",this.useh1=!0,this.useh2=!0,this.H2.x=this.P.x-100,this.H2.y=this.P.y,this.H1.x=this.P.x+100,this.H1.y=this.P.y},PathPoint.prototype.getPointNum=function(){var a=this.parentpath;if(!a)return!1;if(a=a.pathpoints,!a)return!1;for(var b=0;b<a.length;b++)if(a[b]===this)return b;return!1},PathPoint.prototype.roundAll=function(){this.P.x=round(this.P.x,9),this.P.y=round(this.P.y,9),this.H1.x=round(this.H1.x,9),this.H1.y=round(this.H1.y,9),this.H2.x=round(this.H2.x,9),this.H2.y=round(this.H2.y,9)},PathPoint.prototype.findQuadraticSymmetric=function(){return this.Q?{x:this.P.x-this.Q.x+this.P.x,y:this.P.y-this.Q.y+this.P.y}:!1},PathPoint.prototype.getPx=function(){var a=this.P.x;return isNaN(a)&&(a=0),a},PathPoint.prototype.getPy=function(){var a=this.P.y;return isNaN(a)&&(a=0),a},PathPoint.prototype.getH1x=function(){this.H1=this.H1||new Coord(this.P);var a=this.useh1?this.H1.x:this.P.x;return isNaN(a)&&(a=this.P.x||this.H1.x||0,debug("PathPoint NaN found H1.x - falling back to "+a)),a},PathPoint.prototype.getH1y=function(){this.H1=this.H1||new Coord(this.P);var a=this.useh1?this.H1.y:this.P.y;return isNaN(a)&&(a=this.P.y||this.H1.y||0),a},PathPoint.prototype.getH2x=function(){this.H2=this.H2||new Coord(this.P);var a=this.useh2?this.H2.x:this.P.x;return isNaN(a)&&(a=this.P.x||this.H2.x||0),a},PathPoint.prototype.getH2y=function(){this.H2=this.H2||new Coord(this.P);var a=this.useh2?this.H2.y:this.P.y;return isNaN(a)&&(a=this.P.y||this.H2.y||0),a},PathPoint.prototype.getH1Angle=function(){return calculateAngle(this.H1,this.P)},PathPoint.prototype.getH2Angle=function(){return calculateAngle(this.H2,this.P)},PathPoint.prototype.getH1NiceAngle=function(){return calculateNiceAngle(this.getH1Angle())},PathPoint.prototype.getH2NiceAngle=function(){return calculateNiceAngle(this.getH2Angle())},PathPoint.prototype.getH1Length=function(){return calculateLength(this.H1,this.P)},PathPoint.prototype.getH2Length=function(){return calculateLength(this.H2,this.P)},PathPoint.prototype.drawPoint=function(a){a=a||_UI.colors.blue;var b=_GP.projectsettings.pointsize,c=b/2;_UI.glypheditctx.fillStyle=_UI.ms.points.isSelected(this)?"white":a.l65,_UI.glypheditctx.strokeStyle=a.l65,_UI.glypheditctx.fillRect(sx_cx(this.P.x)-c,sy_cy(this.P.y)-c,b,b),_UI.glypheditctx.strokeRect(sx_cx(this.P.x)-c,sy_cy(this.P.y)-c,b,b)},PathPoint.prototype.drawDirectionalityPoint=function(a,b){a=a||_UI.colors.blue,_UI.glypheditctx.fillStyle=_UI.ms.points.isSelected(this)?"white":a.l65,_UI.glypheditctx.strokeStyle=a.l65,_UI.glypheditctx.lineWidth=1;var c={x:this.P.x,y:this.P.y},d={x:this.H2.x,y:this.H2.y};this.useh2||(d={x:b.P.x,y:b.P.y});var e=.5*_GP.projectsettings.pointsize,f=[[3*e,0],[e,e],[-e,e],[-e,-e],[e,-e]],g=[],h=-1*Math.atan2(d.y-c.y,d.x-c.x);h||0===h||(h=this.P.x>this.H2.x?Math.PI:0);for(var i in f)f.hasOwnProperty(i)&&g.push([f[i][0]*Math.cos(h)-f[i][1]*Math.sin(h),f[i][0]*Math.sin(h)+f[i][1]*Math.cos(h)]);_UI.glypheditctx.beginPath(),_UI.glypheditctx.moveTo(g[0][0]+sx_cx(this.P.x),g[0][1]+sy_cy(this.P.y));for(var j in g)j>0&&_UI.glypheditctx.lineTo(g[j][0]+sx_cx(this.P.x),g[j][1]+sy_cy(this.P.y));_UI.glypheditctx.lineTo(g[0][0]+sx_cx(this.P.x),g[0][1]+sy_cy(this.P.y)),_UI.glypheditctx.fill(),_UI.glypheditctx.stroke(),_UI.glypheditctx.fillStyle=a.l65,_UI.glypheditctx.fillRect(sx_cx(this.P.x).makeCrisp(),sy_cy(this.P.y).makeCrisp(),1,1)},PathPoint.prototype.drawHandles=function(a,b,c){c=c||_UI.colors.blue,_UI.glypheditctx.fillStyle=c.l65,_UI.glypheditctx.strokeStyle=c.l65,_UI.glypheditctx.lineWidth=1;var d=_GP.projectsettings.pointsize/2;a&&this.useh1&&(_UI.glypheditctx.beginPath(),_UI.glypheditctx.arc(sx_cx(this.H1.x),sy_cy(this.H1.y),d,0,2*Math.PI,!0),_UI.glypheditctx.closePath(),_UI.glypheditctx.fill(),_UI.glypheditctx.beginPath(),_UI.glypheditctx.moveTo(sx_cx(this.P.x),sy_cy(this.P.y)),_UI.glypheditctx.lineTo(sx_cx(this.H1.x),sy_cy(this.H1.y)),_UI.glypheditctx.closePath(),_UI.glypheditctx.stroke()),b&&this.useh2&&(_UI.glypheditctx.beginPath(),_UI.glypheditctx.arc(sx_cx(this.H2.x),sy_cy(this.H2.y),d,0,2*Math.PI,!0),_UI.glypheditctx.closePath(),_UI.glypheditctx.fill(),_UI.glypheditctx.beginPath(),_UI.glypheditctx.moveTo(sx_cx(this.P.x),sy_cy(this.P.y)),_UI.glypheditctx.lineTo(sx_cx(this.H2.x),sy_cy(this.H2.y)),_UI.glypheditctx.closePath(),_UI.glypheditctx.stroke())},PathPoint.prototype.drawQuadraticHandle=function(a){_UI.glypheditctx.fillStyle=_UI.colors.error.medium,_UI.glypheditctx.strokeStyle=_UI.colors.error.medium,_UI.glypheditctx.lineWidth=1;var b=_GP.projectsettings.pointsize/2;this.Q&&(_UI.glypheditctx.beginPath(),_UI.glypheditctx.arc(sx_cx(this.Q.x),sy_cy(this.Q.y),b,0,2*Math.PI,!0),_UI.glypheditctx.closePath(),_UI.glypheditctx.fill(),_UI.glypheditctx.beginPath(),_UI.glypheditctx.moveTo(sx_cx(this.P.x),sy_cy(this.P.y)),_UI.glypheditctx.lineTo(sx_cx(this.Q.x),sy_cy(this.Q.y)),_UI.glypheditctx.closePath(),_UI.glypheditctx.stroke(),a&&(_UI.glypheditctx.beginPath(),_UI.glypheditctx.moveTo(sx_cx(a.x),sy_cy(a.y)),_UI.glypheditctx.lineTo(sx_cx(this.Q.x),sy_cy(this.Q.y)),_UI.glypheditctx.closePath(),_UI.glypheditctx.stroke()))},PolySegment.prototype.drawPolySegmentOutline=function(a,b){this.segments.forEach(function(c){c.drawSegmentOutline("green",a,b)})},PolySegment.prototype.drawPolySegmentPoints=function(){this.segments.forEach(function(a,b){a.drawSegmentPoints(!1,b)})},PolySegment.prototype.slowlyDrawSegments=function(){function a(){currseg<this.segments.length&&(this.segments[currseg].drawSegmentOutline(),this.segments[currseg].drawSegmentPoints("red",currseg),currseg++,setTimeout(a,600))}currseg=0,setTimeout(a,500)},PolySegment.prototype.getPath=function(){var a=[];a.push(makePathPointFromSegments(this.segments[this.segments.length-1],this.segments[0]));for(var b,c=0;c<this.segments.length-1;c++)b=this.segments[c+1],a.push(makePathPointFromSegments(this.segments[c],b));return new Path({pathpoints:a})},PolySegment.prototype.containsSegment=function(a){for(var b=0;b<this.segments.length;b++)if(segmentsAreEqual(this.segments[b],a))return!0;return!1},PolySegment.prototype.round=function(a){a=isval(a)?a:3;for(var b=0;b<this.segments.length;b++)this.segments[b].round(a)},PolySegment.prototype.splitSegment=function(a,b){debug("\n PolySegment.splitSegment - START"),debug([b]);for(var c,d=0;d<this.segments.length;d++){if(this.segments.length>100)return void console.warn("	 Breaking, over 100");segmentsAreEqual(a,this.segments[d])&&(c=this.segments[d].split(b),debug("	 adding at pos "+d),this.segments.splice(d,1,c[0],c[1]),d++)}debug(" PolySegment.splitSegment - END\n")},PolySegment.prototype.splitSegmentsAtIntersections=function(a){function b(a,b,e){if(!b.containsEndPoint(e))if(b.line)a.splitSegment(b,e),c=!0,d=!0;else{var f=round(b.getSplitFromCoord(e).split,2);0!==f&&1!==f&&(a.splitSegment(b,f),c=!0,d=!0)}}debug("\n PolySegment.splitSegmentsAtIntersections - START");for(var c=!0,d=!1,e=[],f=0;c;){if(10===f){console.warn("	 BREAKING AT LOOP MAX 10");break}if(this.segments.length>100){console.warn("	 BREAKING AT SEGMENTS MAX 100");break}debug("<><><><> LOOP "+f+" <><><><>"),console.group(),c=!1;for(var g,h,i,j,k=[],l=new PolySegment(clone(this)),m=0;m<this.segments.length;m++){for(var n=[],o=0;o<this.segments.length;o++)n.push(m===o?!0:!1);k[m]=n}for(var p=0;p<this.segments.length;p++)for(var q=0;q<this.segments.length;q++)k[p][q]||(h=clone(this.segments[p]),i=clone(this.segments[q]),g=findSegmentIntersections(h,i),g.length>0&&(g.length>1&&(console.error("More than one intersection"),debug(g)),0===f&&e.push(g[0]),e.indexOf(g[0])>-1&&(debug(" ix at loop "+p+" - "+q),j=ixToCoord(g[0]),b(l,h,j),b(l,i,j)))),k[p][q]=!0,k[q][p]=!0;this.segments=l.segments,this.removeSegmentsOverlappingShape(a),this.removeZeroLengthSegments(),this.removeDuplicateSegments(),this.removeRedundantSegments(),0===f&&debug("	 uniqueix.length "+e.length),c||debug("	 Didnt split anything, breaking on "+f),f++,console.groupEnd()}return debug(" PolySegment.splitSegmentsAtIntersections - returning "+d+" - END\n"),d},PolySegment.prototype.stitchSegmentsTogether=function(){function a(a){for(var c,e=0;e<b.length;e++)if(c=clone(b[e]),a.preceeds(c))return d.push(c),b.splice(e,1),clone(c);for(var f=0;f<b.length;f++)if(c=clone(b[f].getReverse()),a.preceeds(c))return d.push(c),b.splice(f,1),clone(c);return!1}debug("\n PolySegment.stitchSegmentsTogether - START");var b=this.segments,c=[],d=[clone(b[0])],e=clone(b[0]),f=0,g=b.length,h=b.length;for(b.splice(0,1);e&&h>f;){if(e=a(e),e===!1&&d.length>1&&(c.push(new PolySegment({segments:clone(d)})),d=[]),e===!1&&b.length)d=[clone(b[0])],e=clone(b[0]),b.splice(0,1);else{if(b.length===g)break;if(0===b.length)break}g=b.length,f++}return d.length>1&&c.push(new PolySegment({segments:clone(d)})),debug(" PolySegment.stitchSegmentsTogether - END\n"),c},PolySegment.prototype.showPoints=function(){debug("\n PolySegment.showPoints - START");for(var a=[],b=0;b<this.segments.length;b++)for(var c=b;c<this.segments.length;c++)b!==c&&(a=a.concat(findCrossingLineSegmentIntersections(this.segments[b],this.segments[c])));debug(a);for(var d,e=0;e<a.length;e++)a[e]&&(d=ixToCoord(a[e]),d.x=sx_cx(d.x),d.y=sx_cx(d.y),draw_CircleHandle(d));debug(" PolySegment.showPoints - END\n")},PolySegment.prototype.removeZeroLengthSegments=function(){debug("\n PolySegment.removeZeroLengthSegments - START");for(var a,b=this.segments.length,c=2,d=0;d<this.segments.length;d++)a=this.segments[d],round(a.p1x,c)===round(a.p1y,c)&&round(a.p1x,c)===round(a.p2x,c)&&round(a.p1x,c)===round(a.p2y,c)&&round(a.p1x,c)===round(a.p3x,c)&&round(a.p1x,c)===round(a.p3y,c)&&round(a.p1x,c)===round(a.p4x,c)&&round(a.p1x,c)===round(a.p4y,c)&&(a.objtype="ZERO");debug(this.segments),this.segments=this.segments.filter(function(a){return"segment"===a.objtype}),debug(" PolySegment.removeZeroLengthSegments - removed "+(b-this.segments.length)+" - END\n")},PolySegment.prototype.removeRedundantSegments=function(){debug("\n PolySegment.removeRedundantSegments - START");for(var a=this.segments.length,b=0;b<this.segments.length;b++)for(var c=0;c<this.segments.length;c++)b!==c&&this.segments[b]&&this.segments[c]&&this.segments[b].isRedundantTo(this.segments[c])&&(this.segments[b]=!1);this.segments=this.segments.filter(function(a){return a}),debug(" PolySegment.removeRedundantSegments - removed "+(a-this.segments.length)+" - END\n")},PolySegment.prototype.removeDuplicateSegments=function(){debug("\n PolySegment.removeDuplicateSegments - START");for(var a=this.segments.length,b=0;b<this.segments.length;b++)for(var c=b;c<this.segments.length;c++)b!==c&&this.segments[b]&&this.segments[c]&&(segmentsAreEqual(this.segments[b],this.segments[c])&&(this.segments[c].objtype="DUPE"),segmentsAreEqual(this.segments[b],this.segments[c].getReverse())&&(this.segments[c].objtype="REVERSE"));debug(this.segments),this.segments=this.segments.filter(function(a){return"segment"===a.objtype}),debug(" PolySegment.removeDuplicateSegments - removed "+(a-this.segments.length)+" - END\n")},PolySegment.prototype.combineInlineSegments=function(){debug("\n PolySegment.combineInlineSegments - START");for(var a,b,c=this.segments.length,d=0;d<this.segments.length;d++)a=this.segments[d],b=d===this.segments.length-1?this.segments[0]:this.segments[d+1],a.line===b.line&&(this.segments[d]=new Segment({p1x:a.p1x,p1y:a.p1y,p4x:b.p4x,p4y:b.p4y}),this.segments.splice(d+1,1),d--);debug(" PolySegment.combineInlineSegments - removed "+(c-this.segments.length)+" - END\n")},PolySegment.prototype.removeSegmentsOverlappingShape=function(a){debug("\n PolySegment.removeSegmentsOverlappingShape - START");for(var b,c,d=this.segments.length,e=3,f=0;f<this.segments.length;f++)split=this.segments[f].split(),b=split[0].p4x,c=split[0].p4y,a.isHere(sx_cx(b),sy_cy(c))&&a.isHere(sx_cx(b),sy_cy(c+e))&&a.isHere(sx_cx(b),sy_cy(c-e))&&a.isHere(sx_cx(b+e),sy_cy(c))&&a.isHere(sx_cx(b-e),sy_cy(c))&&(this.segments[f].objtype="hit");debug(this.segments),this.segments=this.segments.filter(function(a){return"segment"===a.objtype}),debug(" PolySegment.removeSegmentsOverlappingShape - removed "+(d-this.segments.length)+" - END\n")},Segment.prototype.drawSegmentOutline=function(a,b,c){var d=_UI.glypheditctx;d.strokeStyle=a||_UI.colors.green.l65,b=b||0,c=c||0;var e=sx_cx(this.p1x+b),f=sy_cy(this.p1y+c),g=sx_cx(this.p2x+b),h=sy_cy(this.p2y+c),i=sx_cx(this.p3x+b),j=sy_cy(this.p3y+c),k=sx_cx(this.p4x+b),l=sy_cy(this.p4y+c);d.globalAlpha=.2,d.lineWidth=3,d.moveTo(e,f),d.bezierCurveTo(g,h,i,j,k,l),d.stroke()},Segment.prototype.drawSegmentPoints=function(a,b){var c=_UI.glypheditctx;b=isval(b)?b:"•";var d=sx_cx(this.p1x),e=sy_cy(this.p1y),f=sx_cx(this.p2x),g=sy_cy(this.p2y),h=sx_cx(this.p3x),i=sy_cy(this.p3y),j=sx_cx(this.p4x),k=sy_cy(this.p4y);c.strokeStyle=a||_UI.colors.green.l65,c.fillStyle=a||_UI.colors.green.l65,c.font="48px sans-serif",c.globalAlpha=.4,c.fillText(b,d,e),c.globalAlpha=1,c.fillRect(d,e,5,5),c.strokeRect(f,g,5,5),c.strokeRect(h,i,5,5),c.fillRect(j,k,5,5)},Segment.prototype.split=function(a){if("object"==typeof a&&isval(a.x)&&isval(a.y)&&this.line&&"diagonal"!==this.line){var b,c;return"horizontal"===this.line?(b=a.x,c=this.p1y):"vertical"===this.line&&(b=this.p1x,c=a.y),[new Segment({p1x:this.p1x,p1y:this.p1y,p4x:b,p4y:c}),new Segment({p1x:b,p1y:c,p4x:this.p4x,p4y:this.p4y})]}var d=a||.5,e=1-d,f=this.p1x*e+this.p2x*d,g=this.p1y*e+this.p2y*d,h=this.p2x*e+this.p3x*d,i=this.p2y*e+this.p3y*d,j=this.p3x*e+this.p4x*d,k=this.p3y*e+this.p4y*d,l=f*e+h*d,m=g*e+i*d,n=h*e+j*d,o=i*e+k*d,p=l*e+n*d,q=m*e+o*d;return[new Segment({p1x:this.p1x,p1y:this.p1y,p2x:f,p2y:g,p3x:l,p3y:m,p4x:p,p4y:q}),new Segment({p1x:p,p1y:q,p2x:n,p2y:o,p3x:j,p3y:k,p4x:this.p4x,p4y:this.p4y})]},Segment.prototype.round=function(a){a=isval(a)?a:3,this.p1x=round(this.p1x,a),this.p1y=round(this.p1y,a),this.p2x=round(this.p2x,a),this.p2y=round(this.p2y,a),this.p3x=round(this.p3x,a),this.p3y=round(this.p3y,a),this.p4x=round(this.p4x,a),this.p4y=round(this.p4y,a)},Segment.prototype.getSplitFromCoord=function(a){for(var b,c,d=100*this.getLength(),e=999999999,f={},g=0;1>g;g+=1/d)b=this.getCoordFromSplit(g),c=Math.sqrt((b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y)),e>c&&(e=c,f={split:g,distance:c,x:b.x,y:b.y});return f},Segment.prototype.getLength=function(){var a=10,b=Math.abs(this.p1x-this.p4x),c=Math.abs(this.p1y-this.p4y),d=Math.sqrt(b*b+c*c);if(this.line)return d;if(a>d)return d;var e=this.split();return e[0].getLength()+e[1].getLength()},Segment.prototype.getCoordFromSplit=function(a){a=a||.5;var b=1-a,c=this.p1x*b+this.p2x*a,d=this.p1y*b+this.p2y*a,e=this.p2x*b+this.p3x*a,f=this.p2y*b+this.p3y*a,g=this.p3x*b+this.p4x*a,h=this.p3y*b+this.p4y*a,i=c*b+e*a,j=d*b+f*a,k=e*b+g*a,l=f*b+h*a,m=i*b+k*a,n=j*b+l*a;return{x:m,y:n}},Segment.prototype.getReverse=function(){return new Segment({p1x:this.p4x,p1y:this.p4y,p2x:this.p3x,p2y:this.p3y,p3x:this.p2x,p3y:this.p2y,p4x:this.p1x,p4y:this.p1y})},Segment.prototype.getCoord=function(a){return 1===a?{x:this.p1x,y:this.p1y}:2===a?{x:this.p2x,y:this.p2y}:3===a?{x:this.p3x,y:this.p3y}:4===a?{x:this.p4x,y:this.p4y}:void 0},Segment.prototype.getFastMaxes=function(){var a={xmin:Math.min(this.p1x,Math.min(this.p2x,Math.min(this.p3x,this.p4x))),ymin:Math.min(this.p1y,Math.min(this.p2y,Math.min(this.p3y,this.p4y))),xmax:Math.max(this.p1x,Math.max(this.p2x,Math.max(this.p3x,this.p4x))),ymax:Math.max(this.p1y,Math.max(this.p2y,Math.max(this.p3y,this.p4y)))};return a},Segment.prototype.getMaxes=function(){var a={xmin:Math.min(this.p1x,this.p4x),ymin:Math.min(this.p1y,this.p4y),xmax:Math.max(this.p1x,this.p4x),ymax:Math.max(this.p1y,this.p4y)};if(this.line)return a;var b,c,d,e,f,g,h=this.p2x-this.p1x,i=this.p2y-this.p1y,j=this.p3x-this.p2x,k=this.p3y-this.p2y,l=this.p4x-this.p3x,m=this.p4y-this.p3y;return(this.p2x<a.xmin||this.p2x>a.xmax||this.p3x<a.xmin||this.p3x>a.xmax)&&(h+l!==2*j&&(j+=.01),b=2*(h-j),c=2*(h-2*j+l),d=(2*j-2*h)*(2*j-2*h)-2*h*c,e=Math.sqrt(d),f=(b+e)/c,g=(b-e)/c,f>0&&1>f&&checkXbounds(a,getBezierValue(f,this.p1x,this.p2x,this.p3x,this.p4x)),g>0&&1>g&&checkXbounds(a,getBezierValue(g,this.p1x,this.p2x,this.p3x,this.p4x))),(this.p2y<a.ymin||this.p2y>a.ymax||this.p3y<a.ymin||this.p3y>a.ymax)&&(i+m!==2*k&&(k+=.01),b=2*(i-k),c=2*(i-2*k+m),d=(2*k-2*i)*(2*k-2*i)-2*i*c,e=Math.sqrt(d),f=(b+e)/c,g=(b-e)/c,f>0&&1>f&&checkYbounds(a,getBezierValue(f,this.p1y,this.p2y,this.p3y,this.p4y)),g>0&&1>g&&checkYbounds(a,getBezierValue(g,this.p1y,this.p2y,this.p3y,this.p4y))),a},Segment.prototype.isRedundantTo=function(a){return this.line?a.containsPointOnLine(this.getCoord(1))&&a.containsPointOnLine(this.getCoord(4)):!1},Segment.prototype.containsEndPoint=function(a,b){return b=isval(b)?b:1,round(this.p1x,b)===round(a.x,b)&&round(this.p1y,b)===round(a.y,b)?!0:round(this.p4x,b)===round(a.x,b)&&round(this.p4y,b)===round(a.y,b)?!0:!1},Segment.prototype.containsPointOnLine=function(a,b){function c(a,b,c){return b>=a&&c>=b||b>=c&&a>=b}return b=isval(b)?b:1,this.line?this.containsEndPoint(a)?!1:c(this.p1x,a.x,this.p4x)&&c(this.p1y,a.y,this.p4y)&&pointsAreCollinear(this.getCoord(1),this.getCoord(4),a)?!0:!1:!1},Segment.prototype.preceeds=function(a,b){return b=isval(b)?b:1,round(this.p4x,b)===round(a.p1x,b)&&round(this.p4y,b)===round(a.p1y,b)?!0:!1},Segment.prototype.isLine=function(a){a=isval(a)?a:1;var b=round(this.p1x,a)===round(this.p2x,a)&&round(this.p1x,a)===round(this.p3x,a)&&round(this.p1x,a)===round(this.p4x,a);if(b)return"vertical";var c=round(this.p1y,a)===round(this.p2y,a)&&round(this.p1y,a)===round(this.p3y,a)&&round(this.p1y,a)===round(this.p4y,a);if(c)return"horizontal";var d=pointsAreCollinear(this.getCoord(1),this.getCoord(4),this.getCoord(2))&&pointsAreCollinear(this.getCoord(1),this.getCoord(4),this.getCoord(3));return d?"diagonal":!1},Segment.prototype.toString=function(a){return a=isval(a)?a:1,re="",re+=round(this.p1x,a)+"	"+round(this.p1y,a)+"\n",re+=round(this.p4x,a)+"	"+round(this.p4y,a)+"\n"},Shape.prototype.getName=function(){return this.name},Shape.prototype.changed=function(){},Shape.prototype.getName=function(){return this.name},Shape.prototype.drawShape=function(a,b){return this.visible&&(-1===this.path.maxes.xmax&&a===_UI.glypheditctx&&"newpath"!==_UI.selectedtool&&this.calcMaxes(),this.path.drawPath(a,b)),!0},Shape.prototype.draw_PathOutline=function(a,b){a=a||_UI.colors.blue,b=b||1,draw_PathOutline(this,a,b)},Shape.prototype.draw_BoundingBox=function(a,b){a=a||_UI.colors.blue,b=b||1,draw_BoundingBox(this.path.maxes,a,b)},Shape.prototype.draw_BoundingBoxHandles=function(a,b){a=a||_UI.colors.blue,b=b||1,draw_BoundingBoxHandles(this.path.maxes,a,b)},Shape.prototype.makeSVG=function(a,b){a=a||_UI.thumbsize,b=b||_UI.thumbgutter;var c=_GP.projectsettings.upm,d=c-_GP.projectsettings.ascent,e=(a-2*b)/a,f=b/a*c,g=c-2*b,h='<svg version="1.1" ';return h+='xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" ',h+='width="'+a+'" height="'+a+'" viewBox="0,0,'+g+","+g+'">',h+='<g transform="translate('+f+","+(c-d-f/2)+") scale("+e+",-"+e+')">',h+='<path d="',h+=this.path.makeSVGpathData(),h+='"/>',h+="</g>",h+="</svg>"},Shape.prototype.genPostScript=function(a,b){return this.path?this.path.genPathPostScript(a,b):{re:"",lastx:a,lasty:b}},Shape.prototype.makeOpenTypeJSpath=function(a){return this.path.makeOpenTypeJSpath(a)},Shape.prototype.updateShapePosition=function(a,b,c){this.path.updatePathPosition(a,b,c)},Shape.prototype.setShapePosition=function(a,b,c){this.path.setPathPosition(a,b,c)},Shape.prototype.updateShapeSize=function(a,b,c){this.path.updatePathSize(a,b,c)},Shape.prototype.setShapeSize=function(a,b,c){this.path.setPathSize(a,b,c)},Shape.prototype.isOverControlPoint=function(a,b,c){return this.path.isOverControlPoint(a,b,c)},Shape.prototype.flipEW=function(a){this.path.flipEW(a)},Shape.prototype.flipNS=function(a){this.path.flipNS(a)},Shape.prototype.rotate=function(a,b){b=b||this.getCenter(),this.path.rotate(a,b)},Shape.prototype.getCenter=function(){var a=this.getMaxes(),b={};return b.x=(a.xmax-a.xmin)/2+a.xmin,b.y=(a.ymax-a.ymin)/2+a.ymin,b},Shape.prototype.reverseWinding=function(){this.path.reverseWinding()},Shape.prototype.getMaxes=function(){return this.path.getMaxes()},Shape.prototype.calcMaxes=function(){this.path.calcMaxes()},Shape.prototype.getPath=function(){return clone(this.path)},Shape.prototype.getSegment=function(a){return this.path.getSegment(a)},Shape.prototype.resolveSelfOverlaps=function(){var a=this.path.getPolySegment(),b=a.splitSegmentsAtIntersections(this);if(b){var c=[];return c.push(new Shape({name:this.name,path:a.getPath()})),c}},Shape.prototype.isHere=function(a,b){return this.path.isHere(a,b)},Shape.prototype.isOverBoundingBoxHandle=function(a,b){var c=isOverBoundingBoxHandle(a,b,this.path.maxes);return c},Shape.prototype.changeShapeName=function(a){a=strSan(a),""!==a?(this.name=a,history_put("shape name")):showToast("Invalid shape name - shape names must only contain alphanumeric characters or spaces."),redraw({calledby:"Shape Name",redrawcanvas:!1})},Shape.prototype.checkPath=function(){for(var a=0;a<this.path.pathpoints.length;a++){var b=this.path.pathpoints[a];b.P.x||debug(this.name+" p"+a+".P.x is "+b.P.x),b.P.y||debug(this.name+" p"+a+".P.y is "+b.P.y),b.H1.x||debug(this.name+" p"+a+".H1.x is "+b.H1.x),b.H1.y||debug(this.name+" p"+a+".H1.y is "+b.H1.y),b.H2.x||debug(this.name+" p"+a+".H2.x is "+b.H2.x),b.H2.y||debug(this.name+" p"+a+".H2.y is "+b.H2.y)}},Shape.prototype.checkForNaN=function(){return this.path.checkForNaN()},Shape.prototype.drawSegments=function(){var a=this.path.getPolySegment();a.slowlyDrawSegments()};